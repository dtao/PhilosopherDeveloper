<!DOCTYPE html>
<html>
  <head>
    <title>The Philosopher Developer</title>
    <meta charset='utf-8' />
    <meta content='initial-scale=1.0, width=device-width, user-scalable=no' name='viewport' />
    <link href='/stylesheets/application.css' rel='stylesheet' />
    <link href='/stylesheets/pygments.css' rel='stylesheet' />
    <script src='http://w.sharethis.com/button/buttons.js' type='text/javascript'></script>
    <script src='/javascripts/ga.js' type='text/javascript'></script>
    <script src='/javascripts/shareThis.js' type='text/javascript'></script>
    <script src='/javascripts/jquery-1.9.1.min.js' type='text/javascript'></script>
    <!-- I've decided this isn't really worth doing until I make exceptions for -->
    <!-- sites that block iframes. -->
    <!-- %script(type="text/javascript" src="#{SITE_ROOT}/javascripts/main.js") -->
    
    <script type='text/javascript' src='/javascripts/posts.js'></script>
  </head>
  <body>
    <header id='header'>
      <h1><a href="/">The Philosopher Developer</a></h1>
      <h2>half-sound logic, half-decent code</h2>
    </header>
    <article class='abbreviated'>
  <header>
    <h1>
      <span class='title'>
        <a href='/posts/are-strings-really-immutable-in-net.html'>Are strings REALLY immutable in .NET?</a>
      </span>
      <span class='date'>May 28, 2010</span>
    </h1>
  </header>
  <section class='content'>
    <p><strong>Edit: <a href="/posts/string-manipulation-in-net-epilogue.html">I wrote a follow-up</a> to this.</strong></p>

<p class="large">True or false:<br>It’s possible to reverse a string in-place in .NET.</p>

<p>The <strong>beginner</strong> says: True! I could do it like this:</p>

<div class="highlight"><pre><span class="k">static</span> <span class="k">void</span> <span class="nf">ReverseString</span><span class="p">(</span><span class="kt">string</span> <span class="n">str</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">int</span> <span class="n">i</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">j</span> <span class="p">=</span> <span class="n">str</span><span class="p">.</span><span class="n">Length</span> <span class="p">-</span> <span class="m">1</span><span class="p">;</span>
    
    <span class="k">while</span> <span class="p">(</span><span class="n">i</span> <span class="p">&lt;</span> <span class="n">j</span><span class="p">)</span> <span class="p">{</span>
        <span class="kt">char</span> <span class="n">temp</span> <span class="p">=</span> <span class="n">str</span><span class="p">[</span><span class="n">j</span><span class="p">];</span>
        <span class="n">str</span><span class="p">[</span><span class="n">j</span><span class="p">--]</span> <span class="p">=</span> <span class="n">str</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
        <span class="n">str</span><span class="p">[</span><span class="n">i</span><span class="p">++]</span> <span class="p">=</span> <span class="n">temp</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>

<p>I’ve got news for you, friend: <strong>that will not work</strong>. It won’t even <em>compile</em>, in fact. While you can <em>access</em> the characters in a string by index, you cannot <em>set</em> them.</p>

<p>The <strong>intermediate developer</strong> says: False! <a href="http://msdn.microsoft.com/en-us/library/system.string.aspx#remarksToggle">Strings are immutable</a> in .NET.</p>

<p>Good answer! It’s a well-known fact (among experienced .NET developers) that the <code>System.String</code> class is designed to be immutable; you cannot change an instance once it has been instantiated.</p>

<p>This is what often confuses rookie developers who try to write code like the following and fail to understand why it doesn’t work:</p>

<div class="highlight"><pre><span class="kt">string</span> <span class="n">str</span> <span class="p">=</span> <span class="s">"Hello!"</span><span class="p">;</span>

<span class="n">str</span><span class="p">.</span><span class="n">Replace</span><span class="p">(</span><span class="sc">'H'</span><span class="p">,</span> <span class="sc">'J'</span><span class="p">);</span>

<span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="n">str</span><span class="p">);</span>
</pre></div>

<p>The above program outputs “Hello!”, not “Jello!” as some might expect. This is because the <code>String.Replace</code> method <em>returns a new string</em> resulting from the replacement operation. In other words, the program could be “fixed” as follows:</p>

<div class="highlight"><pre><span class="kt">string</span> <span class="n">str</span> <span class="p">=</span> <span class="s">"Hello!"</span><span class="p">;</span>

<span class="c1">// notice: here we are assigning str</span>
<span class="c1">// to a new object</span>
<span class="n">str</span> <span class="p">=</span> <span class="n">str</span><span class="p">.</span><span class="n">Replace</span><span class="p">(</span><span class="sc">'H'</span><span class="p">,</span> <span class="sc">'J'</span><span class="p">);</span>

<span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="n">str</span><span class="p">);</span>
</pre></div>

<p>This is standard behavior for any immutable type (which includes all of the primitive types in .NET such as <code>int</code>, <code>double</code>, <code>bool</code>, etc., as well as <code>DateTime</code> and <code>string</code>).</p>

<p>OK, so, since strings are immutable, clearly you can’t reverse one in-place, right? So the answer must be false?</p>

<p>The <strong>master</strong> says: <strong>True</strong>.</p>
<strong><em>Whaaaaaaaaaaat?!?!?</em></strong>
<p>OK, first of all, you can use the <code>fixed</code> keyword in C# to access a string from a char pointer. This<span class="post-link">... (<a href="/posts/are-strings-really-immutable-in-net.html">read the full post</a>)</span></p>
  </section>
</article>
<article class='abbreviated'>
  <header>
    <h1>
      <span class='title'>
        <a href='/posts/whats-annoying-about-sorted-list-index-of-key.html'>What's annoying about SortedList<TKey, TValue>.IndexOfKey</a>
      </span>
      <span class='date'>May 24, 2010</span>
    </h1>
  </header>
  <section class='content'>
    <p><strong>Update: Some time after writing this post, I created a <a href="http://dtao.github.com/NBinarySearch/">project on GitHub</a> for this.</strong></p>

<p>Here’s a problem I’m sure tons of developers have run into, resulting in much frustration.</p>

<p>Say you have a sorted list of some kind, but it’s not a <code>List(T)</code>, and it’s not an array. In other words, it’s an <code>IList(T)</code> that you know is sorted. If you want to search for an item within that list, it makes sense to utilize a <a href="http://en.wikipedia.org/wiki/Binary_search">binary search</a>, rather than a linear search; but guess what? That doesn’t exist in the .NET framework. There’s <code>List(T).BinarySearch</code>, and there’s <code>Array.BinarySearch(T)</code>, but there’s no general <code>BinarySearch</code> (just like there’s no general <code>Sort</code>).</p>

<p>One data structure where this proves particularly frustrating is <code>SortedList(TKey, TValue)</code>, because, although <code>SortedList(TKey, Value)</code> <em>does</em> have an <code>IndexOfKey</code> method, and this method <em>is</em> a binary search, it returns -1 if the value passed isn’t found. This basically makes it a crippled version of <code>Array.BinarySearch(T)</code>, which actually returns the <strong>negative bitwise complement</strong> of the “next best” index (that of the first value greater than the value searched for) – a useful little piece of information that allows you to write code like this:</p>

<div class="highlight"><pre><span class="kt">int</span> <span class="n">closestIndex</span> <span class="p">=</span> <span class="n">Array</span><span class="p">.</span><span class="n">BinarySearch</span><span class="p">(</span><span class="n">myArray</span><span class="p">,</span> <span class="n">someValue</span><span class="p">);</span>
<span class="k">if</span> <span class="p">(</span><span class="n">closestIndex</span> <span class="p">&lt;</span> <span class="m">0</span><span class="p">)</span>
    <span class="n">closestIndex</span> <span class="p">=</span> <span class="p">~</span><span class="n">closestIndex</span><span class="p">;</span>
</pre></div>

<p>Now, why do you suppose <code>IndexOfKey</code> is inconsistent with <code>List(T).BinarySearch</code> and <code>Array.BinarySearch(T)</code>? Is it due to some subtle difference in implementation that is necessary for the internal structure of <code>SortedList(TKey, TValue)</code>?</p>

<p>Buh, no. Take a look at the source code for the <code>IndexOfKey</code> method using <a href="http://www.red-gate.com/products/reflector/">Reflector</a>, and what you’ll find is this peculiar little bit of code:</p>

<div class="highlight"><pre>    <span class="kt">int</span> <span class="n">num</span> <span class="p">=</span> <span class="n">Array</span><span class="p">.</span><span class="n">BinarySearch</span><span class="p">&lt;</span><span class="n">TKey</span><span class="p">&gt;(</span><span class="k">this</span><span class="p">.</span><span class="n">keys</span><span class="p">,</span> <span class="m">0</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="n">_size</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="n">comparer</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">num</span> <span class="p">&lt;</span> <span class="m">0</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="p">-</span><span class="m">1</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">num</span><span class="p">;</span>
</pre></div>

<p><strong>Seriously</strong>? You’re telling me <code>IndexOfKey</code> <em>actually uses <code>Array.BinarySearch(T)</code></em>,<span class="post-link">... (<a href="/posts/whats-annoying-about-sorted-list-index-of-key.html">read the full post</a>)</span></p>
  </section>
</article>
<article class='abbreviated'>
  <header>
    <h1>
      <span class='title'>
        <a href='/posts/difference-between-converting-and-unboxing.html'>The difference between converting and unboxing: read my mind, compiler!</a>
      </span>
      <span class='date'>May 05, 2010</span>
    </h1>
  </header>
  <section class='content'>
    <p>A <a href="http://stackoverflow.com/questions/2776130/c-implicit-conversions">developer on Stack Overflow</a> was recently perplexed by the fact that the implicit operator he’d defined for his custom type didn’t seem to be working.</p>

<p>The scenario was this: the developer had a <code>DataTable</code> whose columns corresponded to the names of properties for a certain type of object. He had a bunch of <code>PropertyInfo</code> objects, one of which was of type <code>Currency</code> (his custom type with the implicit operator), and he was trying to read the table to get the value of each of his object’s properties. Obviously, since he couldn’t put a <code>Currency</code> object in the <code>DataTable</code>, he used <code>decimal</code> values instead, and defined an implicit conversion from <code>decimal</code> to <code>Currency</code>. Seems pretty smart, right?</p>

<p>Here’s the code he posted:</p>

<div class="highlight"><pre><span class="k">foreach</span> <span class="p">(</span><span class="n">PropertyInfo</span> <span class="n">p</span> <span class="k">in</span> <span class="n">props</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">p</span><span class="p">.</span><span class="n">SetValue</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="n">table</span><span class="p">.</span><span class="n">Rows</span><span class="p">[</span><span class="m">0</span><span class="p">][</span><span class="n">p</span><span class="p">.</span><span class="n">Name</span><span class="p">],</span> <span class="k">null</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>

<p>When it came to the <code>Currency</code> property, the program was throwing an <code>ArgumentException</code>. <em>WTF?</em> this developer thought. <em>What happened to my implicit operator?</em></p>

<p>Well, here’s the first problem: the code above tries to pass a <code>decimal</code> to a call to <code>SetValue</code> for a <code>PropertyInfo</code> object whose <code>PropertyType</code> is <code>Currency</code>. So, presumably, the code could be fixed like this:</p>

<div class="highlight"><pre><span class="k">foreach</span> <span class="p">(</span><span class="n">PropertyInfo</span> <span class="n">p</span> <span class="k">in</span> <span class="n">props</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">Currency</span> <span class="n">c</span> <span class="p">=</span> <span class="p">(</span><span class="n">Currency</span><span class="p">)</span><span class="n">table</span><span class="p">.</span><span class="n">Rows</span><span class="p">[</span><span class="m">0</span><span class="p">][</span><span class="n">p</span><span class="p">.</span><span class="n">Name</span><span class="p">];</span>
    <span class="n">p</span><span class="p">.</span><span class="n">SetValue</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="k">null</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>

<p>That should work, right?</p>

<p>Well, no. Here’s the thing: the <code>implicit</code> operator, as you may know, allows you to convert from one type to another without using an explicit cast. However, whenever you perform such a conversion, you’re still dealing with two fundamentally different types.</p>

<p>When a value type is boxed inside a <code>System.Object</code>, <em>using</em> that value requires first <em>unboxing</em> it – <strong>as its original type</strong>. Many C# developers are surprised to learn that the following code throws an exception:</p>

<div class="highlight"><pre><span class="kt">int</span> <span class="n">int32</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span>
<span class="kt">object</span> <span class="n">boxedInt32</span> <span class="p">=</span> <span class="n">int32</span><span class="p">;</span>
<span class="kt">long</span> <span class="n">int64</span>
</pre></div><span class="post-link">... (<a href="/posts/difference-between-converting-and-unboxing.html">read the full post</a>)</span>
  </section>
</article>
    <footer>
      <ul class='menu'>
        <li><a href="/posts">All Posts</a></li>
        <li><a href="/about">About</a></li>
        <li>
          <a href='http://stackoverflow.com/users/105570' target='_blank'>
            <img alt='StackOverflow' src='/images/icons/stackoverflow-small.png' />
          </a>
        </li>
        <li>
          <a href='https://github.com/dtao' target='_blank'>
            <img alt='GitHub' src='/images/icons/github-small.png' />
          </a>
        </li>
        <li>
          <a href='https://twitter.com/dan_tao' target='_blank'>
            <img alt='Twitter' src='/images/icons/twitter-small.png' />
          </a>
        </li>
        <li>
          <a href='http://feeds.feedburner.com/philosopherdeveloper'>
            <img alt='RSS' src='/images/icons/rss-small.png' />
          </a>
        </li>
      </ul>
    </footer>
  </body>
</html>
