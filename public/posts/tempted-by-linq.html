<!DOCTYPE html>
<html>
  <head>
    <title>Tempted by LINQ? Stop and think - The Philosopher Developer</title>
    <meta charset='utf-8' />
    <meta content='initial-scale=1.0, width=device-width, user-scalable=no' name='viewport' />
    <link href='/stylesheets/application.css' rel='stylesheet' />
    <link href='/stylesheets/pygments.css' rel='stylesheet' />
    <script src='http://w.sharethis.com/button/buttons.js' type='text/javascript'></script>
    <script src='/javascripts/ga.js' type='text/javascript'></script>
    <script src='/javascripts/shareThis.js' type='text/javascript'></script>
    <script src='/javascripts/jquery-1.9.1.min.js' type='text/javascript'></script>
    <!-- I've decided this isn't really worth doing until I make exceptions for -->
    <!-- sites that block iframes. -->
    <!-- %script(type="text/javascript" src="#{SITE_ROOT}/javascripts/main.js") -->
    <script type='text/javascript'>
      //<![CDATA[
        var disqus_shortname = "philosopherdeveloper";
        var disqus_title = "Tempted by LINQ? Stop and think";
      //]]>
    </script>
    
  </head>
  <body>
    <header id='header'>
      <h1>
        <a href='/posts/tempted-by-linq.html'>Tempted by LINQ? Stop and think</a>
      </h1>
      <h2><a href="/">the philosopher developer</a></h2>
    </header>
    <article>
  <header>
    <h1>
      February 09, 2011
    </h1>
    <span class='comments'><a href='#disqus_thread'></a></span>
    <script src='/javascripts/disqusCount.js' type='text/javascript'></script>
    <div class='social'>
      <span class='st_facebook_hcount' displayText='Facebook'></span>
      <span class='st_googleplus_hcount' displayText='Google+'></span>
      <span class='st_twitter_hcount' displayText='Tweet'></span>
      <span class='st_linkedin_hcount' displayText='LinkedIn'></span>
    </div>
  </header>
  <section class='content'>
    <p>LINQ is a really awesome tool for .NET developers, just like a hammer is a really awesome tool for a carpenter. But here’s the thing.</p>

<p>Sometimes I feel like, before LINQ, a .NET developer was akin to a carpenter without a hammer. And then the hammer came along, and carpenters the world over <em>totally</em> fell in love with it. It helped them get so many tasks done more quickly than they could before. But this led them to start using hammers in totally unintended ways.</p>

<p>These carpenters would attend meetings where they would ask questions like, “Does anyone know how to use a hammer as a level?” and “Who can show me how to tighten bolts using my hammer?” Some of the older carpenters at these meetings would shake their heads knowingly, while others would enthusiastically chime in with their clever and novel uses for hammers.</p>

<p>Guys, LINQ is just <strong>one tool</strong>. A carpenter wouldn’t use a hammer for every single task he needs to accomplish. Likewise, we should not be using this <em>one</em> feature of .NET to do everything having anything to do with collections within the language.</p>

<p>This is <em>particularly</em> important to me, because I work on code that must be high-performance all the time at work. I remember when I first introduced my teammates to LINQ; one developer on the team in particular got very excited and started using LINQ extension methods all over the place. For example we would find code like this:</p>

<div class="highlight"><pre><span class="k">For</span> <span class="k">Each</span> <span class="n">prod</span> <span class="ow">As</span> <span class="n">Product</span> <span class="ow">In</span> <span class="n">Products</span><span class="p">.</span><span class="n">Where</span><span class="p">(</span><span class="n">Function</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="n">p</span><span class="p">.</span><span class="n">IsQuoting</span><span class="p">).</span><span class="n">OrderBy</span><span class="p">(</span><span class="n">Function</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="n">p</span><span class="p">.</span><span class="n">Expiration</span><span class="p">).</span><span class="n">ThenBy</span><span class="p">(</span><span class="n">Function</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="n">p</span><span class="p">.</span><span class="n">Strike</span><span class="p">)</span>
    <span class="n">prod</span><span class="p">.</span><span class="n">SendQuotes</span><span class="p">()</span>
<span class="k">Next</span>
</pre></div>

<p>Yeah, that’s <em>terrible</em>. <strong>It’s like using a hammer to perform brain surgery.</strong> But how was my teammate to know, or even suspect there was anything wrong with what he was doing?</p>

<p>I think the .NET culture has embraced LINQ a <em>little</em> too excitedly, at least when it comes to code where performance matters. Joe Duffy <a href="http://www.bluebytesoftware.com/blog/PermaLink,guid,4db70333-295b-441f-80f9-21b90bd44287.aspx">agrees with me</a>, calling LINQ-to-Objects a technology that “makes writing inefficient code very easy.”</p>

<p>Take <a href="http://stackoverflow.com/questions/4903166/c-string-split-question">this Stack Overflow question</a>, for example. A user asked for a way to take a string, split it on a given delimiter (e.g., a whitespace character), and remove the second element in the resulting <code>string[]</code> array.</p>

<p>The top-rated answer to the question looks like this (I in no way intend to disparage this answer—it is a perfectly acceptable solution, and the question did not specify performance as a concern—but only to use it as an illustration of how inefficient LINQ <em>can</em> be):</p>

<div class="highlight"><pre><span class="kt">string</span><span class="p">[]</span> <span class="n">elements</span> <span class="p">=</span> <span class="n">input</span><span class="p">.</span><span class="n">Split</span><span class="p">(</span><span class="n">delimiter</span><span class="p">).</span><span class="n">Where</span><span class="p">((</span><span class="n">s</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="n">i</span> <span class="p">!=</span> <span class="m">1</span><span class="p">).</span><span class="n">ToArray</span><span class="p">();</span>
</pre></div>

<p>This looks nice and all. But now let’s frame it in the form of <strong>plain English instructions</strong>; then you tell me if it sounds efficient to you.</p>

<ol>
<li>Take this big block and break it into smaller blocks in such and such a way; then put all the little blocks into a box.</li>

<li>Now, <em>look at each of the blocks in the box</em> one by one, and give each block a number—zero, one, two, etc. As you are doing this, skip the block numbered “one.”</li>

<li>As you proceed through step 2 above, do the following: put the first four (or so) blocks into a box. Then, if there are more than four blocks, take those four out and start putting them into a <em>new</em> box big enough for <em>eight</em> blocks; and continue putting more blocks into <em>that</em> box. Then, if there are more than <em>eight</em> blocks, take them all out <em>again</em> and put them into a box big enough for <em>sixteen</em> blocks… etc. Keep doubling the size of the box you’re putting blocks into until you’ve got all the blocks in one box.</li>

<li>At the end of all this, see how many blocks you have in your final box. If it’s not <em>exactly</em> as many as the box can hold, then get a new box precisely big enough for all the blocks—not too small, and no bigger than necessary—and put all the blocks in there.</li>
</ol><p>So you see what I mean? Between steps 2 and 4 above, the instructions tell you to get box after box after box, for <em>no good reason</em>, <strong>when you could clearly just use a box big enough to hold <em>one less</em> block than the original box to begin with</strong>, thereby skipping the obnoxiously long and complicated process indicated in step 3. (By the way, yes, I am describing how <code>ToArray</code> works.)</p>

<p>The inefficiency here is a generic one: it is simply the process of allocating an array that holds every element of <em>another</em> array, minus one. My implementation of this, which doesn’t do <em>nearly</em> as much work as the above code—and which I suggested in response to the Stack Overflow question—is as follows:</p>

<div class="highlight"><pre><span class="k">public</span> <span class="k">static</span> <span class="n">T</span><span class="p">[]</span> <span class="n">SkipElement</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;(</span><span class="k">this</span> <span class="n">T</span><span class="p">[]</span> <span class="n">source</span><span class="p">,</span> <span class="kt">int</span> <span class="n">index</span><span class="p">)</span>
<span class="p">{</span>
    <span class="c1">// Leaving out null/bounds checking for brevity.</span>
    <span class="n">T</span><span class="p">[]</span> <span class="n">array</span> <span class="p">=</span> <span class="k">new</span> <span class="n">T</span><span class="p">[</span><span class="n">source</span><span class="p">.</span><span class="n">Length</span> <span class="p">-</span> <span class="m">1</span><span class="p">];</span> <span class="c1">// ONE array allocation (we know how big it should be!)</span>
    <span class="n">Array</span><span class="p">.</span><span class="n">Copy</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="m">0</span><span class="p">,</span> <span class="n">array</span><span class="p">,</span> <span class="m">0</span><span class="p">,</span> <span class="n">index</span><span class="p">);</span>
    <span class="n">Array</span><span class="p">.</span><span class="n">Copy</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">index</span> <span class="p">+</span> <span class="m">1</span><span class="p">,</span> <span class="n">array</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">source</span><span class="p">.</span><span class="n">Length</span> <span class="p">-</span> <span class="n">index</span> <span class="p">-</span> <span class="m">1</span><span class="p">);</span> <span class="c1">// ONE copy, total</span>
    <span class="k">return</span> <span class="n">array</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">// Elsewhere</span>
<span class="kt">string</span><span class="p">[]</span> <span class="n">elements</span> <span class="p">=</span> <span class="n">input</span><span class="p">.</span><span class="n">Split</span><span class="p">(</span><span class="n">delimiter</span><span class="p">).</span><span class="n">SkipElement</span><span class="p">(</span><span class="m">1</span><span class="p">);</span>
</pre></div>

<p>Plenty of developers, if they were to read this post, would roll their eyes and say that worrying about this in the first place constitutes premature optimization. And that’d be a fair point in the majority of cases. But I see no reason why we need to automatically jump to LINQ every time we see a problem like this. I mean, look at that implementation above; is it <em>really</em> so complex? Is it a maintenance headache? Personally, I don’t think so.</p>

<p>I, for one, would prefer not to be the sort of carpenter who reaches straight for his hammer just because he <em>can</em>, or because he <em>likes</em> it, when there’s another tool that will help him <strong>do the same job better</strong>.</p>

<p>Just my two cents.</p>
    <div class='navigation'>
      <a class='previous' href='/posts/multithreading-and-multitasking.html'>Multithreading and multitasking</a>
      <a class='next' href='/posts/how-to-build-a-thread-safe-lock-free-resizable-array.html'>How to build a thread-safe lock-free resizable "array"</a>
    </div>
  </section>
  <section class='comments'>
    <div id='disqus_thread'></div>
    <script src='/javascripts/disqus.js' type='text/javascript'></script>
    <noscript>
      Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a>
    </noscript>
    <a class='dsq-brlink' href='http://disqus.com'>
      comments powered by
      <span class='logo-disqus'>Disqus</span>
    </a>
  </section>
</article>
    <footer>
      <ul class='menu'>
        <li><a href="/posts">All Posts</a></li>
        <li><a href="/about">About</a></li>
        <li>
          <a href='http://stackoverflow.com/users/105570' target='_blank'>
            <img alt='StackOverflow' src='/images/icons/stackoverflow-small.png' />
          </a>
        </li>
        <li>
          <a href='https://github.com/dtao' target='_blank'>
            <img alt='GitHub' src='/images/icons/github-small.png' />
          </a>
        </li>
        <li>
          <a href='https://twitter.com/dan_tao' target='_blank'>
            <img alt='Twitter' src='/images/icons/twitter-small.png' />
          </a>
        </li>
        <li>
          <a href='http://feeds.feedburner.com/philosopherdeveloper'>
            <img alt='RSS' src='/images/icons/rss-small.png' />
          </a>
        </li>
      </ul>
    </footer>
  </body>
</html>
