<!DOCTYPE html>
<html>
  <head>
    <title>String manipulation in .NET: Epilogue - The Philosopher Developer</title>
    <meta charset='utf-8' />
    <meta content='initial-scale=1.0, width=device-width, user-scalable=no' name='viewport' />
    <link href='/stylesheets/application.css' rel='stylesheet' />
    <link href='/stylesheets/pygments.css' rel='stylesheet' />
    <script src='http://w.sharethis.com/button/buttons.js' type='text/javascript'></script>
    <script src='/javascripts/ga.js' type='text/javascript'></script>
    <script src='/javascripts/shareThis.js' type='text/javascript'></script>
    <script src='/javascripts/jquery-1.9.1.min.js' type='text/javascript'></script>
    <script src='/javascripts/main.js' type='text/javascript'></script>
    <script type='text/javascript'>
      //<![CDATA[
        var disqus_shortname = "philosopherdeveloper";
        var disqus_title = "String manipulation in .NET: Epilogue";
      //]]>
    </script>
    
  </head>
  <body>
    <header id='header'>
      <h1>
        <a href='/posts/string-manipulation-in-net-epilogue.html'>String manipulation in .NET: Epilogue</a>
      </h1>
      <h2><a href="/">the philosopher developer</a></h2>
    </header>
    <article>
  <header>
    <h1>
      June 04, 2010
      <span class='comments'><a href='#disqus_thread'></a></span>
      <script src='/javascripts/disqusCount.js' type='text/javascript'></script>
    </h1>
    <div class='social'>
      <span class='st_facebook_hcount' displayText='Facebook'></span>
      <span class='st_googleplus_hcount' displayText='Google+'></span>
      <span class='st_twitter_hcount' displayText='Tweet'></span>
      <span class='st_linkedin_hcount' displayText='LinkedIn'></span>
    </div>
  </header>
  <section class='content'>
    <p>I’ve got a confession to make: I got a little carried away after <a href="/posts/are-strings-really-immutable-in-net.html">my last post</a>. In particular, I became somewhat obsessed with the following discovery: <strong>Not only can you manipulate strings in-place in .NET, you can do so without the <code>unsafe</code> switch, and without any performance penalty whatsoever (as would typically be associated with any form of reflection)</strong>.</p>

<p>Seriously? Yes.</p>

<p>There’s this little-known method in .NET (well, little-known to most developers who work on your run-of-the-mill business applications): <a href="http://msdn.microsoft.com/en-us/library/53cz7sc6.aspx"><code>Delegate.CreateDelegate</code></a>. What this method does, essentially, is provide direct access to a class method via a <code>MethodInfo</code> object, in the form of an appropriately-typed delegate.</p>

<p>In order to understand how this affects string manipulation in .NET, consider the fact that a <code>MethodInfo</code> object can represent <em>any</em> method: <strong>public or non-public</strong>.</p>

<p>In other words, this means you can access the <code>string.SetChar</code> method (totally private – remember, the <code>System.String</code> class was designed to be immutable) <em>directly</em>, without the performance hit of using reflection by calling <code>MethodInfo.Invoke</code>.</p>

<p>To illustrate how this can be done, take a look at this completely evil static helper class I wrote: <a href="https://gist.github.com/3371692">EvilStringHelper</a>.</p>

<p>The <code>EvilStringHelper</code> class provides an extension method on <code>string</code> called <code>ReverseInPlace</code>. This method does exactly what it sounds like.</p>

<p>Now, to illustrate how well this method performs, I thought I’d compare it to its most obvious legal analogue: <a href="http://msdn.microsoft.com/en-us/library/d3877932.aspx"><code>Array.Reverse</code></a> (on a <code>char[]</code> array).</p>

<p>Take a look:</p>

<div class="highlight"><pre><span class="k">class</span> <span class="nc">Program</span> <span class="p">{</span>
    <span class="k">const</span> <span class="kt">int</span> <span class="n">N</span> <span class="p">=</span> <span class="m">10000</span><span class="p">;</span>
    <span class="k">const</span> <span class="kt">int</span> <span class="n">L</span> <span class="p">=</span> <span class="m">10</span><span class="p">;</span>

    <span class="k">static</span> <span class="k">void</span> <span class="nf">Main</span><span class="p">(</span><span class="kt">string</span><span class="p">[]</span> <span class="n">args</span><span class="p">)</span> <span class="p">{</span>
        <span class="kt">var</span> <span class="n">immutableStrings</span> <span class="p">=</span> <span class="k">new</span> <span class="kt">string</span><span class="p">[</span><span class="n">N</span><span class="p">];</span>
        <span class="kt">var</span> <span class="n">mutableStrings</span> <span class="p">=</span> <span class="k">new</span> <span class="kt">string</span><span class="p">[</span><span class="n">N</span><span class="p">];</span>
        <span class="kt">var</span> <span class="n">arrays</span> <span class="p">=</span> <span class="k">new</span> <span class="kt">char</span><span class="p">[</span><span class="n">N</span><span class="p">][];</span>

        <span class="kt">var</span> <span class="n">rand</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Random</span><span class="p">();</span>

        <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span> <span class="n">i</span> <span class="p">&lt;</span> <span class="n">N</span><span class="p">;</span> <span class="p">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
            <span class="kt">var</span> <span class="n">s</span> <span class="p">=</span> <span class="n">GetRandomString</span><span class="p">(</span><span class="n">rand</span><span class="p">,</span> <span class="n">L</span><span class="p">);</span>

            <span class="n">immutableStrings</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="p">=</span> <span class="n">s</span><span class="p">;</span>
            <span class="n">mutableStrings</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="p">=</span> <span class="n">s</span><span class="p">;</span>
            <span class="n">arrays</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="p">=</span> <span class="n">s</span><span class="p">.</span><span class="n">ToCharArray</span><span class="p">();</span>
        <span class="p">}</span>

        <span class="n">TimeSpan</span> <span class="n">immutableStringTime</span> <span class="p">=</span> <span class="n">TimeExecution</span><span class="p">(</span><span class="n">immutableStrings</span><span class="p">.</span><span class="n">Length</span><span class="p">,</span> <span class="n">i</span> <span class="p">=&gt;</span> <span class="n">immutableStrings</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="p">=</span> <span class="n">immutableStrings</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">ReverseOutOfPlace</span><span class="p">());</span>
        <span class="n">TimeSpan</span> <span class="n">mutableStringTime</span> <span class="p">=</span> <span class="n">TimeExecution</span><span class="p">(</span><span class="n">mutableStrings</span><span class="p">.</span><span class="n">Length</span><span class="p">,</span> <span class="n">i</span> <span class="p">=&gt;</span> <span class="n">mutableStrings</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">ReverseInPlace</span><span class="p">());</span>
        <span class="n">TimeSpan</span> <span class="n">arrayTime</span> <span class="p">=</span> <span class="n">TimeExecution</span><span class="p">(</span><span class="n">arrays</span><span class="p">.</span><span class="n">Length</span><span class="p">,</span> <span class="n">i</span> <span class="p">=&gt;</span> <span class="n">Array</span><span class="p">.</span><span class="n">Reverse</span><span class="p">(</span><span class="n">arrays</span><span class="p">[</span><span class="n">i</span><span class="p">]));</span>

        <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="s">"Took {0} ms to reverse {1} strings out-of-place."</span><span class="p">,</span> <span class="n">immutableStringTime</span><span class="p">.</span><span class="n">TotalMilliseconds</span><span class="p">,</span> <span class="n">N</span><span class="p">);</span>
        <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="s">"Took {0} ms to reverse {1} strings in-place."</span><span class="p">,</span> <span class="n">mutableStringTime</span><span class="p">.</span><span class="n">TotalMilliseconds</span><span class="p">,</span> <span class="n">N</span><span class="p">);</span>
        <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="s">"Took {0} ms to reverse {1} arrays."</span><span class="p">,</span> <span class="n">arrayTime</span><span class="p">.</span><span class="n">TotalMilliseconds</span><span class="p">,</span> <span class="n">N</span><span class="p">);</span>
        <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">();</span>

        <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="s">"First 10 reversal results (to verify proper reversal):"</span><span class="p">);</span>
        <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span> <span class="n">i</span> <span class="p">&lt;</span> <span class="m">10</span><span class="p">;</span> <span class="p">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="s">"{0}: {1} {2} {3}"</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">immutableStrings</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">mutableStrings</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="k">new</span> <span class="kt">string</span><span class="p">(</span><span class="n">arrays</span><span class="p">[</span><span class="n">i</span><span class="p">]));</span>
        <span class="p">}</span>

        <span class="n">Console</span><span class="p">.</span><span class="n">ReadLine</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="k">static</span> <span class="n">TimeSpan</span> <span class="nf">TimeExecution</span><span class="p">(</span><span class="kt">int</span> <span class="n">count</span><span class="p">,</span> <span class="n">Action</span><span class="p">&lt;</span><span class="kt">int</span><span class="p">&gt;</span> <span class="n">action</span><span class="p">)</span> <span class="p">{</span>
        <span class="kt">var</span> <span class="n">stopwatch</span> <span class="p">=</span> <span class="n">Stopwatch</span><span class="p">.</span><span class="n">StartNew</span><span class="p">();</span>
        <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span> <span class="n">i</span> <span class="p">&lt;</span> <span class="n">count</span><span class="p">;</span> <span class="p">++</span><span class="n">i</span><span class="p">)</span>
            <span class="n">action</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
        <span class="n">stopwatch</span><span class="p">.</span><span class="n">Stop</span><span class="p">();</span>

        <span class="k">return</span> <span class="n">stopwatch</span><span class="p">.</span><span class="n">Elapsed</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">static</span> <span class="kt">string</span> <span class="nf">GetRandomString</span><span class="p">(</span><span class="n">Random</span> <span class="n">rand</span><span class="p">,</span> <span class="kt">int</span> <span class="n">length</span><span class="p">)</span> <span class="p">{</span>
        <span class="kt">char</span><span class="p">[]</span> <span class="n">chars</span> <span class="p">=</span> <span class="k">new</span> <span class="kt">char</span><span class="p">[</span><span class="n">length</span><span class="p">];</span>

        <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span> <span class="n">i</span> <span class="p">&lt;</span> <span class="n">length</span><span class="p">;</span> <span class="p">++</span><span class="n">i</span><span class="p">)</span>
            <span class="n">chars</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="p">=</span> <span class="p">(</span><span class="kt">char</span><span class="p">)</span><span class="n">rand</span><span class="p">.</span><span class="n">Next</span><span class="p">(</span><span class="m">65</span><span class="p">,</span> <span class="m">91</span><span class="p">);</span>

        <span class="k">return</span> <span class="k">new</span> <span class="nf">string</span><span class="p">(</span><span class="n">chars</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>

<p>The output of the above code is pretty astounding:</p>

<div class="highlight"><pre>Took 3.1009 ms to reverse 10000 strings out-of-place.
Took 1.8825 ms to reverse 10000 strings in-place.
Took 1.7296 ms to reverse 10000 arrays.

First 10 reversal results (to verify proper reversal):
0: VTDTZOMEED VTDTZOMEED VTDTZOMEED
1: ZEQZBQHUMY ZEQZBQHUMY ZEQZBQHUMY
2: SLEXKVEZTI SLEXKVEZTI SLEXKVEZTI
3: IYJPLVIBAF IYJPLVIBAF IYJPLVIBAF
4: ZXSEVUTCBZ ZXSEVUTCBZ ZXSEVUTCBZ
5: EQAFJLNGPS EQAFJLNGPS EQAFJLNGPS
6: EMLKYPBSPB EMLKYPBSPB EMLKYPBSPB
7: AJFRGAWSPM AJFRGAWSPM AJFRGAWSPM
8: MWOTQZLGFF MWOTQZLGFF MWOTQZLGFF
9: WDBJJHTTOG WDBJJHTTOG WDBJJHTTOG
</pre></div>

<p>Do you <em>see</em> that? Reversing strings in-place turned out to be <strong>almost as fast as reversing <code>char[]</code> arrays!</strong> Yeah, that’s pretty nuts. For something that’s supposed to be completely and utterly illegal, it turns out string manipulation in .NET is actually ridiculously inexpensive. (Also notice that the fastest way I could think of to reverse a string the kosher way (i.e., out-of-place)–which itself includes some unsafe low-level performance optimizations with <code>stackalloc</code> and <code>fixed</code>–really can’t compete with in-place reversal.)</p>

<p>By the way, if you peruse the <code>EvilStringHelper</code> class, you might notice that it does more than just <code>ReverseInPlace</code>. In particular, you might notice that it uses <code>Delegate.CreateDelegate</code> to provide direct access not just to the uber-private <code>string.SetChar</code> method, but to another, perhaps even <em>more</em> invasive little fellow: <code>string.SetLength</code>.</p>

<p>With these together, we end up with this shocking possibility: taking a string, and just flat-out <strong>changing it to something completely different</strong>.</p>

<p>Here’s some example code that shows how messed up this gets:</p>

<div class="highlight"><pre><span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="s">"Hello!"</span><span class="p">);</span>

<span class="s">"Hello!"</span><span class="p">.</span><span class="n">ChangeTo</span><span class="p">(</span><span class="s">"Goodbye!"</span><span class="p">);</span>
<span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="s">"Hello!"</span><span class="p">);</span>

<span class="s">"Hello!"</span><span class="p">.</span><span class="n">SetChar</span><span class="p">(</span><span class="m">5</span><span class="p">,</span> <span class="sc">'o'</span><span class="p">);</span>
<span class="s">"Hello!"</span><span class="p">.</span><span class="n">SetChar</span><span class="p">(</span><span class="m">6</span><span class="p">,</span> <span class="sc">'y'</span><span class="p">);</span>
<span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="s">"Hello!"</span><span class="p">);</span>

<span class="s">"Hello!"</span><span class="p">.</span><span class="n">ReverseInPlace</span><span class="p">();</span>
<span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="s">"Hello!"</span><span class="p">);</span>

<span class="kt">string</span><span class="p">.</span><span class="n">Empty</span><span class="p">.</span><span class="n">ChangeTo</span><span class="p">(</span><span class="s">"I am definitely not empty."</span><span class="p">);</span>
<span class="s">"Hello!"</span><span class="p">.</span><span class="n">ChangeTo</span><span class="p">(</span><span class="s">""</span><span class="p">);</span>
<span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="s">"Hello!"</span><span class="p">);</span>

<span class="n">Console</span><span class="p">.</span><span class="n">ReadLine</span><span class="p">();</span>
</pre></div>

<p>Can you possibly guess what the above code outputs? Let me spare you the mind-tingling anticipation and just tell you:</p>

<div class="highlight"><pre>Hello!
Goodbye!
Goodboy!
!yobdooG
I am definitely not empty.
</pre></div>

<p>Just let that simmer. <strong>Five consecutive calls to <code>Console.WriteLine("Hello!")</code> output five completely different strings.</strong></p>

<p>OK, I’ve definitely beat this topic to death. But you have to admit: it’s pretty freaky.</p>
    <div class='navigation'>
      <a class='previous' href='/posts/are-strings-really-immutable-in-net.html'>Are strings REALLY immutable in .NET?</a>
      <a class='next' href='/posts/white-angels-and-black-devils.html'>White angels & black devils</a>
    </div>
  </section>
  <section class='comments'>
    <div id='disqus_thread'></div>
    <script src='/javascripts/disqus.js' type='text/javascript'></script>
    <noscript>
      Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a>
    </noscript>
    <a class='dsq-brlink' href='http://disqus.com'>
      comments powered by
      <span class='logo-disqus'>Disqus</span>
    </a>
  </section>
</article>
    <footer>
      <ul class='menu'>
        <li><a href="/posts">All Posts</a></li>
        <li><a href="/about">About</a></li>
        <li>
          <a href='http://stackoverflow.com/users/105570' target='_blank'>
            <img alt='StackOverflow' src='/images/icons/stackoverflow-small.png' />
          </a>
        </li>
        <li>
          <a href='https://github.com/dtao' target='_blank'>
            <img alt='GitHub' src='/images/icons/github-small.png' />
          </a>
        </li>
        <li>
          <a href='https://twitter.com/dan_tao' target='_blank'>
            <img alt='Twitter' src='/images/icons/twitter-small.png' />
          </a>
        </li>
        <li>
          <a href='http://feeds.feedburner.com/philosopherdeveloper'>
            <img alt='RSS' src='/images/icons/rss-small.png' />
          </a>
        </li>
      </ul>
    </footer>
  </body>
</html>
