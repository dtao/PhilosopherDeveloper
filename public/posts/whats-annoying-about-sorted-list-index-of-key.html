<!DOCTYPE html>
<html>
  <head>
    <title>What's annoying about SortedList<TKey, TValue>.IndexOfKey - The Philosopher Developer</title>
    <meta charset='utf-8' />
    <meta content='initial-scale=1.0, width=device-width, user-scalable=no' name='viewport' />
    <link href='/stylesheets/application.css' rel='stylesheet' />
    <link href='/stylesheets/pygments.css' rel='stylesheet' />
    <script src='http://w.sharethis.com/button/buttons.js' type='text/javascript'></script>
    <script src='/javascripts/ga.js' type='text/javascript'></script>
    <script src='/javascripts/shareThis.js' type='text/javascript'></script>
    <script src='/javascripts/jquery-1.9.1.min.js' type='text/javascript'></script>
    <script src='/javascripts/main.js' type='text/javascript'></script>
    <script type='text/javascript'>
      //<![CDATA[
        var disqus_shortname = "philosopherdeveloper";
        var disqus_title = "What's annoying about SortedList<TKey, TValue>.IndexOfKey";
      //]]>
    </script>
    
  </head>
  <body>
    <header id='header'>
      <h1>
        <a href='/posts/whats-annoying-about-sorted-list-index-of-key.html'>What's annoying about SortedList<TKey, TValue>.IndexOfKey</a>
      </h1>
      <h2><a href="/">the philosopher developer</a></h2>
    </header>
    <article>
  <header>
    <h1>
      May 24, 2010
      <span class='comments'><a href='#disqus_thread'></a></span>
      <script src='/javascripts/disqusCount.js' type='text/javascript'></script>
    </h1>
    <div class='social'>
      <span class='st_facebook_hcount' displayText='Facebook'></span>
      <span class='st_googleplus_hcount' displayText='Google+'></span>
      <span class='st_twitter_hcount' displayText='Tweet'></span>
      <span class='st_linkedin_hcount' displayText='LinkedIn'></span>
    </div>
  </header>
  <section class='content'>
    <p>Here’s a problem I’m sure tons of developers have run into, resulting in much frustration.</p>

<p>Say you have a sorted list of some kind, but it’s not a <code>List(T)</code>, and it’s not an array. In other words, it’s an <code>IList(T)</code> that you know is sorted. If you want to search for an item within that list, it makes sense to utilize a <a href="http://en.wikipedia.org/wiki/Binary_search">binary search</a>, rather than a linear search; but guess what? That doesn’t exist in the .NET framework. There’s <code>List(T).BinarySearch</code>, and there’s <code>Array.BinarySearch(T)</code>, but there’s no general <code>BinarySearch</code> (just like there’s no general <code>Sort</code>).</p>

<p>One data structure where this proves particularly frustrating is <code>SortedList(TKey, TValue)</code>, because, although <code>SortedList(TKey, Value)</code> <em>does</em> have an <code>IndexOfKey</code> method, and this method <em>is</em> a binary search, it returns -1 if the value passed isn’t found. This basically makes it a crippled version of <code>Array.BinarySearch(T)</code>, which actually returns the <strong>negative bitwise complement</strong> of the “next best” index (that of the first value greater than the value searched for) – a useful little piece of information that allows you to write code like this:</p>

<div class="highlight"><pre><span class="kt">int</span> <span class="n">closestIndex</span> <span class="p">=</span> <span class="n">Array</span><span class="p">.</span><span class="n">BinarySearch</span><span class="p">(</span><span class="n">myArray</span><span class="p">,</span> <span class="n">someValue</span><span class="p">);</span>
<span class="k">if</span> <span class="p">(</span><span class="n">closestIndex</span> <span class="p">&lt;</span> <span class="m">0</span><span class="p">)</span>
    <span class="n">closestIndex</span> <span class="p">=</span> <span class="p">~</span><span class="n">closestIndex</span><span class="p">;</span>
</pre></div>

<p>Now, why do you suppose <code>IndexOfKey</code> is inconsistent with <code>List(T).BinarySearch</code> and <code>Array.BinarySearch(T)</code>? Is it due to some subtle difference in implementation that is necessary for the internal structure of <code>SortedList(TKey, TValue)</code>?</p>

<p>Buh, no. Take a look at the source code for the <code>IndexOfKey</code> method using <a href="http://www.red-gate.com/products/reflector/">Reflector</a>, and what you’ll find is this peculiar little bit of code:</p>

<div class="highlight"><pre>    <span class="kt">int</span> <span class="n">num</span> <span class="p">=</span> <span class="n">Array</span><span class="p">.</span><span class="n">BinarySearch</span><span class="p">&lt;</span><span class="n">TKey</span><span class="p">&gt;(</span><span class="k">this</span><span class="p">.</span><span class="n">keys</span><span class="p">,</span> <span class="m">0</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="n">_size</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="n">comparer</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">num</span> <span class="p">&lt;</span> <span class="m">0</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="p">-</span><span class="m">1</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">num</span><span class="p">;</span>
</pre></div>

<p><strong>Seriously</strong>? You’re telling me <code>IndexOfKey</code> <em>actually uses <code>Array.BinarySearch(T)</code></em>, and just refuses to return the same value?</p>

<p>This is NOT ACCEPTABLE (to me, anyway). Thankfully, Reflector allows us to take a gander at the implementation of <code>Array.BinarySearch(T)</code> as well, which can be refitted to work on any <code>IList(T)</code>, no problem. (Believe me when I say this is <strong>extremely preferable</strong> to implementing one’s own binary search… especially when you see how simple this implementation is.)</p>

<p><strong>Behold, a generic <code>BinarySearch</code> method that will work on <em>any</em> <code>IList(T)</code>, based on Microsoft’s own <code>Array.BinarySearch(T)</code> implementation:</strong></p>

<p>(I’ve also included the obvious overloads.)</p>

<div class="highlight"><pre><span class="k">public</span> <span class="k">static</span> <span class="kt">int</span> <span class="n">BinarySearch</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;(</span><span class="k">this</span> <span class="n">IList</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span> <span class="n">list</span><span class="p">,</span> <span class="kt">int</span> <span class="n">index</span><span class="p">,</span> <span class="kt">int</span> <span class="n">length</span><span class="p">,</span> <span class="n">T</span> <span class="k">value</span><span class="p">,</span> <span class="n">IComparer</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span> <span class="n">comparer</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">list</span> <span class="p">==</span> <span class="k">null</span><span class="p">)</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nf">ArgumentNullException</span><span class="p">(</span><span class="s">"list"</span><span class="p">);</span>
    <span class="k">else</span> <span class="nf">if</span> <span class="p">(</span><span class="n">index</span> <span class="p">&lt;</span> <span class="m">0</span> <span class="p">||</span> <span class="n">length</span> <span class="p">&lt;</span> <span class="m">0</span><span class="p">)</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nf">ArgumentOutOfRangeException</span><span class="p">(</span>
            <span class="p">(</span><span class="n">index</span> <span class="p">&lt;</span> <span class="m">0</span><span class="p">)</span> <span class="p">?</span> <span class="s">"index"</span> <span class="p">:</span> <span class="s">"length"</span>
        <span class="p">);</span>
    <span class="k">else</span> <span class="nf">if</span> <span class="p">(</span><span class="n">list</span><span class="p">.</span><span class="n">Count</span> <span class="p">-</span> <span class="n">index</span> <span class="p">&lt;</span> <span class="n">length</span><span class="p">)</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nf">ArgumentException</span><span class="p">();</span>

    <span class="kt">int</span> <span class="n">lower</span> <span class="p">=</span> <span class="n">index</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">upper</span> <span class="p">=</span> <span class="p">(</span><span class="n">index</span> <span class="p">+</span> <span class="n">length</span><span class="p">)</span> <span class="p">-</span> <span class="m">1</span><span class="p">;</span>

    <span class="k">while</span> <span class="p">(</span><span class="n">lower</span> <span class="p">&lt;=</span> <span class="n">upper</span><span class="p">)</span> <span class="p">{</span>
        <span class="kt">int</span> <span class="n">adjustedIndex</span> <span class="p">=</span> <span class="n">lower</span> <span class="p">+</span> <span class="p">((</span><span class="n">upper</span> <span class="p">-</span> <span class="n">lower</span><span class="p">)</span> <span class="p">&gt;&gt;</span> <span class="m">1</span><span class="p">);</span>
        <span class="kt">int</span> <span class="n">comparison</span> <span class="p">=</span> <span class="n">comparer</span><span class="p">.</span><span class="n">Compare</span><span class="p">(</span><span class="n">list</span><span class="p">[</span><span class="n">adjustedIndex</span><span class="p">],</span> <span class="k">value</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">comparison</span> <span class="p">==</span> <span class="m">0</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">adjustedIndex</span><span class="p">;</span>
        <span class="k">else</span> <span class="nf">if</span> <span class="p">(</span><span class="n">comparison</span> <span class="p">&lt;</span> <span class="m">0</span><span class="p">)</span>
            <span class="n">lower</span> <span class="p">=</span> <span class="n">adjustedIndex</span> <span class="p">+</span> <span class="m">1</span><span class="p">;</span>
        <span class="k">else</span>
            <span class="n">upper</span> <span class="p">=</span> <span class="n">adjustedIndex</span> <span class="p">-</span> <span class="m">1</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="p">~</span><span class="n">lower</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">public</span> <span class="k">static</span> <span class="kt">int</span> <span class="n">BinarySearch</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;(</span><span class="k">this</span> <span class="n">IList</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span> <span class="n">list</span><span class="p">,</span> <span class="n">T</span> <span class="k">value</span><span class="p">,</span> <span class="n">IComparer</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span> <span class="n">comparer</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">list</span><span class="p">.</span><span class="n">BinarySearch</span><span class="p">(</span><span class="m">0</span><span class="p">,</span> <span class="n">list</span><span class="p">.</span><span class="n">Count</span><span class="p">,</span> <span class="k">value</span><span class="p">,</span> <span class="n">comparer</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">public</span> <span class="k">static</span> <span class="kt">int</span> <span class="n">BinarySearch</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;(</span><span class="k">this</span> <span class="n">IList</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span> <span class="n">list</span><span class="p">,</span> <span class="n">T</span> <span class="k">value</span><span class="p">)</span> <span class="k">where</span> <span class="n">T</span> <span class="p">:</span> <span class="n">IComparable</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">list</span><span class="p">.</span><span class="n">BinarySearch</span><span class="p">(</span><span class="k">value</span><span class="p">,</span> <span class="n">Comparer</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;.</span><span class="n">Default</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>

<p>Feel free to add this code to any static helper class you like. I know I will.</p>
    <div class='navigation'>
      <a class='previous' href='/posts/difference-between-converting-and-unboxing.html'>The difference between converting and unboxing: read my mind, compiler!</a>
      <a class='next' href='/posts/are-strings-really-immutable-in-net.html'>Are strings REALLY immutable in .NET?</a>
    </div>
  </section>
  <section class='comments'>
    <div id='disqus_thread'></div>
    <script src='/javascripts/disqus.js' type='text/javascript'></script>
    <noscript>
      Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a>
    </noscript>
    <a class='dsq-brlink' href='http://disqus.com'>
      comments powered by
      <span class='logo-disqus'>Disqus</span>
    </a>
  </section>
</article>
    <footer>
      <ul class='menu'>
        <li><a href="/posts">All Posts</a></li>
        <li><a href="/about">About</a></li>
        <li>
          <a href='http://stackoverflow.com/users/105570' target='_blank'>
            <img alt='StackOverflow' src='/images/icons/stackoverflow-small.png' />
          </a>
        </li>
        <li>
          <a href='https://github.com/dtao' target='_blank'>
            <img alt='GitHub' src='/images/icons/github-small.png' />
          </a>
        </li>
        <li>
          <a href='https://twitter.com/dan_tao' target='_blank'>
            <img alt='Twitter' src='/images/icons/twitter-small.png' />
          </a>
        </li>
        <li>
          <a href='http://feeds.feedburner.com/philosopherdeveloper'>
            <img alt='RSS' src='/images/icons/rss-small.png' />
          </a>
        </li>
      </ul>
    </footer>
  </body>
</html>
