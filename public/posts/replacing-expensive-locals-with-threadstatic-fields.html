<!DOCTYPE html>
<html>
  <head>
    <title>Performance trick: replacing expensive locals with [ThreadStatic] fields - The Philosopher Developer</title>
    <meta charset='utf-8' />
    <meta content='initial-scale=1.0, width=device-width, user-scalable=no' name='viewport' />
    <link href='/stylesheets/application.css' rel='stylesheet' />
    <link href='/stylesheets/pygments.css' rel='stylesheet' />
    <script src='http://w.sharethis.com/button/buttons.js' type='text/javascript'></script>
    <script src='/javascripts/ga.js' type='text/javascript'></script>
    <script src='/javascripts/shareThis.js' type='text/javascript'></script>
    <script src='/javascripts/jquery-1.9.1.min.js' type='text/javascript'></script>
    <!-- I've decided this isn't really worth doing until I make exceptions for -->
    <!-- sites that block iframes. -->
    <!-- %script(type="text/javascript" src="#{SITE_ROOT}/javascripts/main.js") -->
    <script type='text/javascript'>
      //<![CDATA[
        var disqus_shortname = "philosopherdeveloper";
        var disqus_title = "Performance trick: replacing expensive locals with [ThreadStatic] fields";
      //]]>
    </script>
    
  </head>
  <body>
    <header id='header'>
      <h1>
        <a href='/posts/replacing-expensive-locals-with-threadstatic-fields.html'>Performance trick: replacing expensive locals with [ThreadStatic] fields</a>
      </h1>
      <h2><a href="/">the philosopher developer</a></h2>
    </header>
    <article>
  <header>
    <h1>
      February 01, 2011
      <span class='comments'><a href='#disqus_thread'></a></span>
      <script src='/javascripts/disqusCount.js' type='text/javascript'></script>
    </h1>
    <div class='social'>
      <span class='st_facebook_hcount' displayText='Facebook'></span>
      <span class='st_googleplus_hcount' displayText='Google+'></span>
      <span class='st_twitter_hcount' displayText='Tweet'></span>
      <span class='st_linkedin_hcount' displayText='LinkedIn'></span>
    </div>
  </header>
  <section class='content'>
    <p>In the course of profiling some performance-critical code today, I happened upon a method that gets called a <em>lot</em> in my company’s application, which allocates new array objects on every run.</p>

<p>I thought, hey, maybe this could be optimized: instead of allocating a new array on every call, I could use <a href="http://msdn.microsoft.com/en-us/library/system.threadstaticattribute.aspx"><code>[ThreadStatic]</code></a> and re-use the same array whenever possible (each thread gets one, so race conditions shouldn’t be an issue).</p>

<p>I <a href="http://stackoverflow.com/questions/4864974/using-threadstatic-to-replace-expensive-locals-good-idea">asked the community at Stack Overflow about this</a>, and got basically the answer I expected: <strong>profile and see</strong>. So that’s what I did!</p>

<h3 id="the_test_1">The Test</h3>

<p>Below is a relatively short program I wrote to test the performance difference between these two scenarios, both in terms of execution speed and that of memory allocation.</p>

<div class="highlight"><pre><span class="k">using</span> <span class="nn">System</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Diagnostics</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Linq.Expressions</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Threading</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Threading.Tasks</span><span class="p">;</span>

<span class="k">namespace</span> <span class="nn">ThreadStaticTest</span>
<span class="p">{</span>
    <span class="k">class</span> <span class="nc">PerformanceBenchmark</span>
    <span class="p">{</span>
        <span class="k">public</span> <span class="nf">PerformanceBenchmark</span><span class="p">(</span><span class="kt">string</span> <span class="n">name</span><span class="p">,</span> <span class="n">TimeSpan</span> <span class="n">elapsed</span><span class="p">,</span> <span class="kt">int</span> <span class="n">gen0</span><span class="p">,</span> <span class="kt">int</span> <span class="n">gen1</span><span class="p">,</span> <span class="kt">int</span> <span class="n">gen2</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">Name</span> <span class="p">=</span> <span class="n">name</span><span class="p">;</span>
            <span class="n">Elapsed</span> <span class="p">=</span> <span class="n">elapsed</span><span class="p">;</span>
            <span class="n">GCCollections</span> <span class="p">=</span> <span class="k">new</span> <span class="kt">int</span><span class="p">[]</span> <span class="p">{</span> <span class="n">gen0</span><span class="p">,</span> <span class="n">gen1</span><span class="p">,</span> <span class="n">gen2</span> <span class="p">};</span>
        <span class="p">}</span>

        <span class="k">public</span> <span class="kt">string</span> <span class="n">Name</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">private</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
        <span class="k">public</span> <span class="n">TimeSpan</span> <span class="n">Elapsed</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">private</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
        <span class="k">public</span> <span class="kt">int</span><span class="p">[]</span> <span class="n">GCCollections</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">private</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">class</span> <span class="nc">Program</span>
    <span class="p">{</span>
        <span class="k">const</span> <span class="kt">int</span> <span class="n">N</span> <span class="p">=</span> <span class="m">50</span><span class="p">;</span>
        <span class="k">const</span> <span class="kt">int</span> <span class="n">Repetitions</span> <span class="p">=</span> <span class="m">1000000</span><span class="p">;</span>

<span class="na">        [ThreadStatic]</span>
        <span class="k">static</span> <span class="kt">double</span><span class="p">[]</span> <span class="n">_array</span><span class="p">;</span>

        <span class="k">static</span> <span class="k">void</span> <span class="nf">Main</span><span class="p">(</span><span class="kt">string</span><span class="p">[]</span> <span class="n">args</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="s">"CPU count: {0}"</span><span class="p">,</span> <span class="n">Environment</span><span class="p">.</span><span class="n">ProcessorCount</span><span class="p">);</span>

            <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="s">"Testing local array allocation..."</span><span class="p">);</span>
            <span class="n">PerformanceBenchmark</span> <span class="n">localArrayPerf</span> <span class="p">=</span> <span class="n">Benchmark</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="n">CalculateSum</span><span class="p">(</span><span class="n">AllocateArray</span><span class="p">()),</span> <span class="n">Repetitions</span><span class="p">);</span>

            <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="s">"Testing ThreadStatic attribute..."</span><span class="p">);</span>
            <span class="n">PerformanceBenchmark</span> <span class="n">threadStaticPerf</span> <span class="p">=</span> <span class="n">Benchmark</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="n">CalculateSum</span><span class="p">(</span><span class="n">GetThreadStaticArray</span><span class="p">()),</span> <span class="n">Repetitions</span><span class="p">);</span>

            <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="s">"Finished! results:"</span><span class="p">);</span>
            <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">();</span>

            <span class="n">PrintBenchmark</span><span class="p">(</span><span class="n">localArrayPerf</span><span class="p">);</span>

            <span class="n">PrintBenchmark</span><span class="p">(</span><span class="n">threadStaticPerf</span><span class="p">);</span>

            <span class="n">Console</span><span class="p">.</span><span class="n">ReadLine</span><span class="p">();</span>
        <span class="p">}</span>

        <span class="k">static</span> <span class="k">void</span> <span class="nf">PrintBenchmark</span><span class="p">(</span><span class="n">PerformanceBenchmark</span> <span class="n">benchmark</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span>
            <span class="p">(</span>
                <span class="s">"Results for '{0}':\n{1} ms, GC[{2}/{3}/{4}]"</span><span class="p">,</span>
                <span class="n">benchmark</span><span class="p">.</span><span class="n">Name</span><span class="p">,</span>
                <span class="n">benchmark</span><span class="p">.</span><span class="n">Elapsed</span><span class="p">.</span><span class="n">TotalMilliseconds</span><span class="p">,</span>
                <span class="n">benchmark</span><span class="p">.</span><span class="n">GCCollections</span><span class="p">[</span><span class="m">0</span><span class="p">],</span>
                <span class="n">benchmark</span><span class="p">.</span><span class="n">GCCollections</span><span class="p">[</span><span class="m">1</span><span class="p">],</span>
                <span class="n">benchmark</span><span class="p">.</span><span class="n">GCCollections</span><span class="p">[</span><span class="m">2</span><span class="p">]</span>
            <span class="p">);</span>
        <span class="p">}</span>

        <span class="k">static</span> <span class="n">PerformanceBenchmark</span> <span class="nf">Benchmark</span><span class="p">(</span><span class="n">Expression</span><span class="p">&lt;</span><span class="n">Action</span><span class="p">&gt;</span> <span class="n">expression</span><span class="p">,</span> <span class="kt">int</span> <span class="n">repetitions</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">Action</span> <span class="n">action</span> <span class="p">=</span> <span class="n">expression</span><span class="p">.</span><span class="n">Compile</span><span class="p">();</span>

            <span class="n">GC</span><span class="p">.</span><span class="n">Collect</span><span class="p">();</span>

            <span class="kt">int</span> <span class="n">gen0</span> <span class="p">=</span> <span class="n">GC</span><span class="p">.</span><span class="n">CollectionCount</span><span class="p">(</span><span class="m">0</span><span class="p">);</span>
            <span class="kt">int</span> <span class="n">gen1</span> <span class="p">=</span> <span class="n">GC</span><span class="p">.</span><span class="n">CollectionCount</span><span class="p">(</span><span class="m">1</span><span class="p">);</span>
            <span class="kt">int</span> <span class="n">gen2</span> <span class="p">=</span> <span class="n">GC</span><span class="p">.</span><span class="n">CollectionCount</span><span class="p">(</span><span class="m">2</span><span class="p">);</span>

            <span class="n">Stopwatch</span> <span class="n">stopwatch</span> <span class="p">=</span> <span class="n">Stopwatch</span><span class="p">.</span><span class="n">StartNew</span><span class="p">();</span>
            <span class="n">Parallel</span><span class="p">.</span><span class="n">For</span><span class="p">(</span><span class="m">0</span><span class="p">,</span> <span class="n">repetitions</span><span class="p">,</span> <span class="n">i</span> <span class="p">=&gt;</span> <span class="n">action</span><span class="p">());</span>
            <span class="n">stopwatch</span><span class="p">.</span><span class="n">Stop</span><span class="p">();</span>

            <span class="n">gen0</span> <span class="p">=</span> <span class="n">GC</span><span class="p">.</span><span class="n">CollectionCount</span><span class="p">(</span><span class="m">0</span><span class="p">)</span> <span class="p">-</span> <span class="n">gen0</span><span class="p">;</span>
            <span class="n">gen1</span> <span class="p">=</span> <span class="n">GC</span><span class="p">.</span><span class="n">CollectionCount</span><span class="p">(</span><span class="m">1</span><span class="p">)</span> <span class="p">-</span> <span class="n">gen1</span><span class="p">;</span>
            <span class="n">gen2</span> <span class="p">=</span> <span class="n">GC</span><span class="p">.</span><span class="n">CollectionCount</span><span class="p">(</span><span class="m">2</span><span class="p">)</span> <span class="p">-</span> <span class="n">gen2</span><span class="p">;</span>

            <span class="k">return</span> <span class="k">new</span> <span class="nf">PerformanceBenchmark</span><span class="p">(</span><span class="n">expression</span><span class="p">.</span><span class="n">ToString</span><span class="p">(),</span> <span class="n">stopwatch</span><span class="p">.</span><span class="n">Elapsed</span><span class="p">,</span> <span class="n">gen0</span><span class="p">,</span> <span class="n">gen1</span><span class="p">,</span> <span class="n">gen2</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="k">static</span> <span class="kt">double</span> <span class="nf">CalculateSum</span><span class="p">(</span><span class="kt">double</span><span class="p">[]</span> <span class="n">array</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="kt">double</span> <span class="n">sum</span> <span class="p">=</span> <span class="m">0.0</span><span class="p">;</span>
            <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span> <span class="n">i</span> <span class="p">&lt;</span> <span class="n">array</span><span class="p">.</span><span class="n">Length</span><span class="p">;</span> <span class="p">++</span><span class="n">i</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="n">sum</span> <span class="p">+=</span> <span class="n">i</span><span class="p">;</span>
            <span class="p">}</span>

            <span class="k">return</span> <span class="n">sum</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">static</span> <span class="kt">double</span><span class="p">[]</span> <span class="nf">AllocateArray</span><span class="p">()</span>
        <span class="p">{</span>
            <span class="kt">var</span> <span class="n">values</span> <span class="p">=</span> <span class="k">new</span> <span class="kt">double</span><span class="p">[</span><span class="n">N</span><span class="p">];</span>
            <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span> <span class="n">i</span> <span class="p">&lt;</span> <span class="n">values</span><span class="p">.</span><span class="n">Length</span><span class="p">;</span> <span class="p">++</span><span class="n">i</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="n">values</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="p">=</span> <span class="p">(</span><span class="kt">double</span><span class="p">)</span><span class="n">i</span><span class="p">;</span>
            <span class="p">}</span>

            <span class="k">return</span> <span class="n">values</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">static</span> <span class="kt">double</span><span class="p">[]</span> <span class="nf">GetThreadStaticArray</span><span class="p">()</span>
        <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">_array</span> <span class="p">==</span> <span class="k">null</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="n">_array</span> <span class="p">=</span> <span class="n">AllocateArray</span><span class="p">();</span>
            <span class="p">}</span>

            <span class="k">return</span> <span class="n">_array</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>

<h3 id="the_result_2">The Result</h3>

<p>Here is the output I got from the above test on a 24-core server:</p>

<div class="highlight"><pre>CPU count: 24
Testing local array allocation...
Testing ThreadStatic attribute...
Finished! results:

Results for '() =&gt; CalculateSum(AllocateArray())':
2183.7554 ms, GC[616/1/0]
Results for '() =&gt; CalculateSum(GetThreadStaticArray())':
70.9415 ms, GC[0/0/0]
</pre></div>

<p><em>Wow</em>, that’s a big difference. Using <code>[ThreadStatic]</code> fields performed something like <strong>30x faster</strong>, and without <em>any</em> garbage collections compared to using local arrays instantiated on every call (which also caused <strong>616</strong> generation-0 GCs and even a generation-1 GC!).</p>

<p>So yeah, this was definitely worth trying out. Am I saying that you should replace all of your local variables with <code>[ThreadStatic]</code> fields? Of course not. It will naturally depend on the “cost” of the object being instantiated; in my test above, I deal with <code>double[]</code> arrays of 50-elements. That mirrors the method I originally set out to optimize. To me, that is something like a “medium” cost. But there are other factors to consider as well, as mentioned by some Stack Overflow users:</p>

<ul>
<li>This approach could definitely go horribly wrong with recursion. Keep that in mind.</li>

<li>Using <code>[ThreadStatic]</code> is a messy implementation detail that should <em>definitely</em> be encapsulated, invisible to any external code (but that’s just common sense, right?).</li>

<li>This approach is far less obvious and therefore arguably less comprehensible/maintainable than the more straightforward local allocation approach. Whether it’s an appropriate measure to take in a given context will depend on how critical performance is in that context, among other factors.</li>
</ul><p>That said, I will definitely add this trick to my tool belt for cases like this that I might encounter in the future. The magnitude of the performance improvement was, to me, really quite shocking.</p>
    <div class='navigation'>
    </div>
  </section>
  <section class='comments'>
    <div id='disqus_thread'></div>
    <script src='/javascripts/disqus.js' type='text/javascript'></script>
    <noscript>
      Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a>
    </noscript>
    <a class='dsq-brlink' href='http://disqus.com'>
      comments powered by
      <span class='logo-disqus'>Disqus</span>
    </a>
  </section>
</article>
    <footer>
      <ul class='menu'>
        <li><a href="/posts">All Posts</a></li>
        <li><a href="/about">About</a></li>
        <li>
          <a href='http://stackoverflow.com/users/105570' target='_blank'>
            <img alt='StackOverflow' src='/images/icons/stackoverflow-small.png' />
          </a>
        </li>
        <li>
          <a href='https://github.com/dtao' target='_blank'>
            <img alt='GitHub' src='/images/icons/github-small.png' />
          </a>
        </li>
        <li>
          <a href='https://twitter.com/dan_tao' target='_blank'>
            <img alt='Twitter' src='/images/icons/twitter-small.png' />
          </a>
        </li>
        <li>
          <a href='http://feeds.feedburner.com/philosopherdeveloper'>
            <img alt='RSS' src='/images/icons/rss-small.png' />
          </a>
        </li>
      </ul>
    </footer>
  </body>
</html>
