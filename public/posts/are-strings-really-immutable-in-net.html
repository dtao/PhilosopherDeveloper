<!DOCTYPE html>
<html>
  <head>
    <title>Are strings REALLY immutable in .NET? - The Philosopher Developer</title>
    <meta charset='utf-8' />
    <meta content='initial-scale=1.0, width=device-width, user-scalable=no' name='viewport' />
    <link href='/stylesheets/application.css' rel='stylesheet' />
    <link href='/stylesheets/pygments.css' rel='stylesheet' />
    <script src='http://w.sharethis.com/button/buttons.js' type='text/javascript'></script>
    <script src='/javascripts/ga.js' type='text/javascript'></script>
    <script src='/javascripts/shareThis.js' type='text/javascript'></script>
    <script src='/javascripts/jquery-1.9.1.min.js' type='text/javascript'></script>
    <script src='/javascripts/main.js' type='text/javascript'></script>
    <script type='text/javascript'>
      //<![CDATA[
        var disqus_shortname = "philosopherdeveloper";
        var disqus_title = "Are strings REALLY immutable in .NET?";
      //]]>
    </script>
    
  </head>
  <body>
    <header id='header'>
      <h1>
        <a href='/posts/are-strings-really-immutable-in-net.html'>Are strings REALLY immutable in .NET?</a>
      </h1>
      <h2><a href="/">the philosopher developer</a></h2>
    </header>
    <article>
  <header>
    <h1>
      May 28, 2010
      <span class='comments'><a href='#disqus_thread'></a></span>
      <script src='/javascripts/disqusCount.js' type='text/javascript'></script>
    </h1>
    <div class='social'>
      <span class='st_facebook_hcount' displayText='Facebook'></span>
      <span class='st_googleplus_hcount' displayText='Google+'></span>
      <span class='st_twitter_hcount' displayText='Tweet'></span>
      <span class='st_linkedin_hcount' displayText='LinkedIn'></span>
    </div>
  </header>
  <section class='content'>
    <p><strong>Edit: <a href="/posts/string-manipulation-in-net-epilogue.html">I wrote a follow-up</a> to this.</strong></p>

<p class="large">True or false:<br>It’s possible to reverse a string in-place in .NET.</p>

<p>The <strong>beginner</strong> says: True! I could do it like this:</p>

<div class="highlight"><pre><span class="k">static</span> <span class="k">void</span> <span class="nf">ReverseString</span><span class="p">(</span><span class="kt">string</span> <span class="n">str</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">int</span> <span class="n">i</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">j</span> <span class="p">=</span> <span class="n">str</span><span class="p">.</span><span class="n">Length</span> <span class="p">-</span> <span class="m">1</span><span class="p">;</span>
    
    <span class="k">while</span> <span class="p">(</span><span class="n">i</span> <span class="p">&lt;</span> <span class="n">j</span><span class="p">)</span> <span class="p">{</span>
        <span class="kt">char</span> <span class="n">temp</span> <span class="p">=</span> <span class="n">str</span><span class="p">[</span><span class="n">j</span><span class="p">];</span>
        <span class="n">str</span><span class="p">[</span><span class="n">j</span><span class="p">--]</span> <span class="p">=</span> <span class="n">str</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
        <span class="n">str</span><span class="p">[</span><span class="n">i</span><span class="p">++]</span> <span class="p">=</span> <span class="n">temp</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>

<p>I’ve got news for you, friend: <strong>that will not work</strong>. It won’t even <em>compile</em>, in fact. While you can <em>access</em> the characters in a string by index, you cannot <em>set</em> them.</p>

<p>The <strong>intermediate developer</strong> says: False! <a href="http://msdn.microsoft.com/en-us/library/system.string.aspx#remarksToggle">Strings are immutable</a> in .NET.</p>

<p>Good answer! It’s a well-known fact (among experienced .NET developers) that the <code>System.String</code> class is designed to be immutable; you cannot change an instance once it has been instantiated.</p>

<p>This is what often confuses rookie developers who try to write code like the following and fail to understand why it doesn’t work:</p>

<div class="highlight"><pre><span class="kt">string</span> <span class="n">str</span> <span class="p">=</span> <span class="s">"Hello!"</span><span class="p">;</span>

<span class="n">str</span><span class="p">.</span><span class="n">Replace</span><span class="p">(</span><span class="sc">'H'</span><span class="p">,</span> <span class="sc">'J'</span><span class="p">);</span>

<span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="n">str</span><span class="p">);</span>
</pre></div>

<p>The above program outputs “Hello!”, not “Jello!” as some might expect. This is because the <code>String.Replace</code> method <em>returns a new string</em> resulting from the replacement operation. In other words, the program could be “fixed” as follows:</p>

<div class="highlight"><pre><span class="kt">string</span> <span class="n">str</span> <span class="p">=</span> <span class="s">"Hello!"</span><span class="p">;</span>

<span class="c1">// notice: here we are assigning str</span>
<span class="c1">// to a new object</span>
<span class="n">str</span> <span class="p">=</span> <span class="n">str</span><span class="p">.</span><span class="n">Replace</span><span class="p">(</span><span class="sc">'H'</span><span class="p">,</span> <span class="sc">'J'</span><span class="p">);</span>

<span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="n">str</span><span class="p">);</span>
</pre></div>

<p>This is standard behavior for any immutable type (which includes all of the primitive types in .NET such as <code>int</code>, <code>double</code>, <code>bool</code>, etc., as well as <code>DateTime</code> and <code>string</code>).</p>

<p>OK, so, since strings are immutable, clearly you can’t reverse one in-place, right? So the answer must be false?</p>

<p>The <strong>master</strong><sup id="fnref:1"><a href="#fn:1" rel="footnote">1</a></sup> says: <strong>True</strong>.</p>
<strong><em>Whaaaaaaaaaaat?!?!?</em></strong>
<p>OK, first of all, you can use the <code>fixed</code> keyword in C# to access a string from a char pointer. This means that if you’re compiling in <code>unsafe</code> mode, reversing a string in-place actually becomes totally straightforward:</p>

<div class="highlight"><pre><span class="k">static</span> <span class="k">unsafe</span> <span class="k">void</span> <span class="nf">ReverseString</span><span class="p">(</span><span class="kt">string</span> <span class="n">str</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">int</span> <span class="n">i</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">j</span> <span class="p">=</span> <span class="n">str</span><span class="p">.</span><span class="n">Length</span> <span class="p">-</span> <span class="m">1</span><span class="p">;</span>

    <span class="k">fixed</span> <span class="p">(</span><span class="kt">char</span><span class="p">*</span> <span class="n">fstr</span> <span class="p">=</span> <span class="n">str</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">while</span> <span class="p">(</span><span class="n">i</span> <span class="p">&lt;</span> <span class="n">j</span><span class="p">)</span> <span class="p">{</span>
            <span class="kt">char</span> <span class="n">temp</span> <span class="p">=</span> <span class="n">fstr</span><span class="p">[</span><span class="n">j</span><span class="p">];</span>

            <span class="n">fstr</span><span class="p">[</span><span class="n">j</span><span class="p">--]</span> <span class="p">=</span> <span class="n">fstr</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
            <span class="n">fstr</span><span class="p">[</span><span class="n">i</span><span class="p">++]</span> <span class="p">=</span> <span class="n">temp</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>

<p>What’s that, you say? Nobody compiles with the <code>/unsafe</code> switch? Fair enough. But did you know it’s actually <em>still</em> possible to reverse a string in-place in .NET, <strong>without compiling in <code>unsafe</code> mode</strong>? It’s sad, but true; and it’s all thanks to an evil little gremlin named “Reflection”:</p>

<div class="highlight"><pre><span class="k">static</span> <span class="k">void</span> <span class="nf">ReverseString</span><span class="p">(</span><span class="kt">string</span> <span class="n">str</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">int</span> <span class="n">i</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">j</span> <span class="p">=</span> <span class="n">str</span><span class="p">.</span><span class="n">Length</span> <span class="p">-</span> <span class="m">1</span><span class="p">;</span>

    <span class="n">MethodInfo</span> <span class="n">setter</span> <span class="p">=</span> <span class="k">typeof</span><span class="p">(</span><span class="kt">string</span><span class="p">).</span><span class="n">GetMethod</span><span class="p">(</span>
        <span class="s">"SetChar"</span><span class="p">,</span>
        <span class="n">BindingFlags</span><span class="p">.</span><span class="n">Instance</span> <span class="p">|</span> <span class="n">BindingFlags</span><span class="p">.</span><span class="n">NonPublic</span>
    <span class="p">);</span>

    <span class="k">while</span> <span class="p">(</span><span class="n">i</span> <span class="p">&lt;</span> <span class="n">j</span><span class="p">)</span> <span class="p">{</span>
        <span class="kt">char</span> <span class="n">temp</span> <span class="p">=</span> <span class="n">str</span><span class="p">[</span><span class="n">j</span><span class="p">];</span>

        <span class="n">setter</span><span class="p">.</span><span class="n">Invoke</span><span class="p">(</span><span class="n">str</span><span class="p">,</span> <span class="k">new</span> <span class="kt">object</span><span class="p">[]</span> <span class="p">{</span> <span class="n">j</span><span class="p">--,</span> <span class="n">str</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="p">});</span>
        <span class="n">setter</span><span class="p">.</span><span class="n">Invoke</span><span class="p">(</span><span class="n">str</span><span class="p">,</span> <span class="k">new</span> <span class="kt">object</span><span class="p">[]</span> <span class="p">{</span> <span class="n">i</span><span class="p">++,</span> <span class="n">temp</span> <span class="p">});</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>

<p>So, actually, <strong>yes, it is possible to reverse a string in-place in .NET, even when compiling without the <code>/unsafe</code> switch</strong>. It’s evil, and you should <strong>never</strong> do it; but it’s <em>possible</em>.</p>

<p>By the way, in case you’re not grasping why this is so evil, let me just offer a quick little illustration to show why having a method like this would be absolutely horrible. (This also explains pretty clearly why strings are immutable in .NET in the first place.)</p>

<div class="highlight"><pre><span class="n">Console</span><span class="p">.</span><span class="n">Write</span><span class="p">(</span><span class="s">"What's your name? "</span><span class="p">);</span>
<span class="kt">string</span> <span class="n">name</span> <span class="p">=</span> <span class="n">Console</span><span class="p">.</span><span class="n">ReadLine</span><span class="p">();</span>

<span class="kt">string</span> <span class="n">reverse</span> <span class="p">=</span> <span class="n">name</span><span class="p">;</span>
<span class="n">ReverseString</span><span class="p">(</span><span class="n">reverse</span><span class="p">);</span>

<span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span>
    <span class="s">"Your name is {0}, which spelled backwards is {1}."</span><span class="p">,</span>
    <span class="n">name</span><span class="p">,</span>
    <span class="n">reverse</span>
<span class="p">);</span>
</pre></div>

<p>The output of the above program (for “Daniel”) is this:</p>

<pre><code>Your name is leinaD, which spelled backwards is leinaD.</code></pre>

<p>Oh crap! Well, that makes sense, because we set <code>name</code> and <code>reverse</code> to the same object. But what about this?</p>

<div class="highlight"><pre><span class="kt">string</span> <span class="n">x</span> <span class="p">=</span> <span class="s">"Hello"</span><span class="p">;</span>
<span class="kt">string</span> <span class="n">y</span> <span class="p">=</span> <span class="s">"Hello"</span><span class="p">;</span>

<span class="n">ReverseString</span><span class="p">(</span><span class="n">x</span><span class="p">);</span>

<span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="n">y</span><span class="p">);</span>
</pre></div>

<p>At least <em>that</em> should output “Hello”, right? Since <code>x</code> and <code>y</code> are two different objects?</p>

<p>Nope. <a href="http://msdn.microsoft.com/en-us/library/system.string.intern.aspx">String literals are interned in .NET</a>, which means that <code>x</code> and <code>y</code> in the above code are <em>actually the same object</em>; so when you reverse <code>x</code> in-place, you’ve also reversed <code>y</code>.</p>

<p>“Cut it out!” you are saying. “That’s enough! This is insanity! I <em>get</em> it already!”</p>

<p>Do you, though? <strong>DO YOU?</strong></p>

<p>Just to make sure, let me throw one more insane little bit of code your way. Just to make sure you fully, completely understand how weird this is.</p>

<p><strong>What do you think this code will output?</strong></p>

<div class="highlight"><pre><span class="n">ReverseString</span><span class="p">(</span><span class="s">"Hello!"</span><span class="p">);</span>

<span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="s">"Hello!"</span><span class="p">);</span>
</pre></div>

<p>“No,” I hear you saying. “It can’t be… surely not…”</p>

<p>Oh, but it can. And it is.</p>

<pre><code>!olleH</code></pre>

<p><strong>That’s what the above code outputs!</strong> I swear! Try it for yourself and see!</p>

<p>In short, then: yes, it’s possible to reverse a string in-place in .NET. But <strong>DON’T EVER, EVER DO IT</strong>. (In other words, do as I say, not as I do. I am sharing my foolhardy experiment with you so that you don’t have to experience such terror for yourselves.)</p>
<div class="footnotes">
<hr>
<ol><li id="fn:1">
<p>This is meant to be tongue-in-cheek, by the way. I am definitely <em>not</em> claiming to be a .NET master. <a href="#fnref:1" rev="footnote">↩</a></p>
</li></ol>
</div>
    <div class='navigation'>
      <a class='previous' href='/posts/difference-between-converting-and-unboxing.html'>The difference between converting and unboxing: read my mind, compiler!</a>
      <a class='next' href='/posts/string-manipulation-in-net-epilogue.html'>String manipulation in .NET: Epilogue</a>
    </div>
  </section>
  <section class='comments'>
    <div id='disqus_thread'></div>
    <script src='/javascripts/disqus.js' type='text/javascript'></script>
    <noscript>
      Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a>
    </noscript>
    <a class='dsq-brlink' href='http://disqus.com'>
      comments powered by
      <span class='logo-disqus'>Disqus</span>
    </a>
  </section>
</article>
    <footer>
      <ul class='menu'>
        <li><a href="/posts">All Posts</a></li>
        <li><a href="/about">About</a></li>
        <li>
          <a href='http://stackoverflow.com/users/105570' target='_blank'>
            <img alt='StackOverflow' src='/images/icons/stackoverflow-small.png' />
          </a>
        </li>
        <li>
          <a href='https://github.com/dtao' target='_blank'>
            <img alt='GitHub' src='/images/icons/github-small.png' />
          </a>
        </li>
        <li>
          <a href='https://twitter.com/dan_tao' target='_blank'>
            <img alt='Twitter' src='/images/icons/twitter-small.png' />
          </a>
        </li>
        <li>
          <a href='http://feeds.feedburner.com/philosopherdeveloper'>
            <img alt='RSS' src='/images/icons/rss-small.png' />
          </a>
        </li>
      </ul>
    </footer>
  </body>
</html>
