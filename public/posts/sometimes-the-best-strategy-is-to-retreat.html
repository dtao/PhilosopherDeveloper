<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<head>
  <title>Sometimes the best strategy is to retreat - The Philosopher Developer</title>
  <meta content='initial-scale=1.0, width=device-width, user-scalable=no' name='viewport' />
  <link href='/stylesheets/application.css' rel='stylesheet' />
  <link href='/stylesheets/pygments.css' rel='stylesheet' />
  <script src='http://w.sharethis.com/button/buttons.js' type='text/javascript'></script>
  <script src='/javascripts/ga.js' type='text/javascript'></script>
  <script src='/javascripts/shareThis.js' type='text/javascript'></script>
  
</head>
<body>
  <header id='header'>
    <h1>
      <a href='/posts/sometimes-the-best-strategy-is-to-retreat.html'>Sometimes the best strategy is to retreat</a>
    </h1>
    <h2><a href="/">the philosopher developer</a></h2>
  </header>
  <article>
  <header>
    <h1>February 28, 2011</h1>
    <div class='social'>
      <span class='st_facebook_hcount' displayText='Facebook'></span>
      <span class='st_googleplus_hcount' displayText='Google+'></span>
      <span class='st_twitter_hcount' displayText='Tweet'></span>
      <span class='st_linkedin_hcount' displayText='LinkedIn'></span>
    </div>
  </header>
  <section class='content'>
    <p>I have a few remarks to make about <a href="http://dtao.github.com/ConcurrentList/">my <code>ConcurrentList&lt;T&gt;</code> class</a>, which I have written about a <a href="/posts/how-to-build-a-thread-safe-lock-free-resizable-array.html">couple</a> of <a href="/posts/boy-can-dream.html">times</a> already.</p>

<p><em>What, are you “retreating” from your concurrent list idea?</em> In a way, yes. Let me explain. From the beginning, my concept of the usefulness of a lock-free <code>IList&lt;T&gt;</code> implementation was that it would scale better than using a <code>List&lt;T&gt;</code> plus <code>lock</code> statements by eliminating contention when many threads are accessing the list concurrently.</p>

<p>Is this actually true? Accessing the list <code>how</code>?</p>

<p>Since a concurrent implementation of <code>Insert</code>, <code>RemoveAt</code> etc. is not supported in <code>ConcurrentList&lt;T&gt;</code>, there are really only a few operations that need to be considered:</p>

<ul>
<li>Getting/setting an item at a specified index</li>

<li>Adding to the list</li>

<li>Iterating over the list</li>
</ul><p>Critically, I think the assumption is that one would need a lock-free data structure to optimize the scenario where multiple threads may be <em>reading</em> from the list (via accessing items at random indexes) while one or more other threads are <em>adding</em> to it. <strong>I actually don’t think you need a lock-free data structure for this at all.</strong></p>

<p>Here’s the thing: if you’ve got a <code>List&lt;T&gt;</code>, and you synchronize all calls to <code>Add</code> with, e.g., a <code>lock</code> statement, <strong>you don’t need to also synchronize reads</strong>. They will <em>always</em> be thread-safe. Accessing an element at an index of a <code>List&lt;T&gt;</code> that is <em>only</em> growing with calls to <code>Add</code> <em>will</em> work from multiple threads. If you are skeptical, consider what actually happens when <code>Add</code> is called (<strong>warning: reliance upon specific implementation details ahead!</strong>):</p>

<ol>
<li>
<p>The <code>List&lt;T&gt;</code> gets the next available index in its internal array.</p>
</li>

<li>
<p>If the index is beyond the end of the array:</p>

<ol>
<li>A new array is allocated.</li>

<li>The elements of the current array are copied over.</li>

<li>A reference to this new array is assigned to the <code>List&lt;T&gt;</code>’s internal array field.</li>
</ol>
</li>

<li>
<p>The element in the array at the index found in step 1 is assigned to the input value.</p>
</li>
</ol><p>Assuming an always-accurate return value for <code>Count</code>, and assuming the above process is always synchronized, <strong>there is no reason why threads reading from the list need to be synchronized</strong>.</p>

<p>To demonstrate this, I added the <code>SynchronizedList&lt;T&gt;</code> class to <a href="https://github.com/dtao/ConcurrentList">my GitHub repo</a>. Take a look and see for yourself: this class, which simply uses a <code>List&lt;T&gt;</code> internally and synchronizes calls to <code>Add</code> while exposing everything else <em>without synchronization</em>, passes all unit tests.</p>

<p>Now, I told a little fib moments ago. I’m really <em>not</em> giving up on the concurrent list idea; rather, I am rethinking what its actual usefulness is. I still think there is value to having a lock-free <code>Add</code> implementation, which is <strong>guaranteed contention-free growth</strong>. On a plain <code>List&lt;T&gt;</code> the cost of <code>Add</code> is <em>very</em> small <em>most</em> of the time; but every now and then, it actually requires an expensive array allocation + full copy. In something like a real-time system, this might be a very bad thing to synchronize; the thread contention could create a pretty large albeit ephemeral bottleneck. So maybe the <code>ConcurrentList&lt;T&gt;</code> class can be a very specialized collection for scenarios like this.</p>

<p>I don’t know. To be honest, though I’ve put a lot of thought into this topic, I haven’t put a lot of thought into <em>this</em> blog post specifically; so it’s possible I have not really provided a very compelling or convincing explanation of my feelings on the matter.</p>

<p>What I do know is this: <em>next</em> up, I’m going to propose a data structure which leverages the concept of fast thread-safe adds (whether synchronized via locking or lock-free) to provide O(1) random inserts and removals. Pretty exciting, huh?</p>
  </section>
  <section class='comments'>
    <div id='disqus_thread'></div>
    <script src='/javascripts/disqus.js' type='text/javascript'></script>
    <noscript>
      Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a>
    </noscript>
    <a class='dsq-brlink' href='http://disqus.com'>
      comments powered by
      <span class='logo-disqus'>Disqus</span>
    </a>
  </section>
</article>
  <footer>
    <ul class='menu'>
      <li><a href="/posts">All Posts</a></li>
      <li><a href="/about">About</a></li>
      <li>
        <a href='http://stackoverflow.com/users/105570' target='_blank'>
          <img alt='StackOverflow' src='/images/icons/stackoverflow-small.png' />
        </a>
      </li>
      <li>
        <a href='https://github.com/dtao' target='_blank'>
          <img alt='GitHub' src='/images/icons/github-small.png' />
        </a>
      </li>
      <li>
        <a href='https://twitter.com/dan_tao' target='_blank'>
          <img alt='Twitter' src='/images/icons/twitter-small.png' />
        </a>
      </li>
      <li>
        <a href='http://feeds.feedburner.com/philosopherdeveloper'>
          <img alt='RSS' src='/images/icons/rss-small.png' />
        </a>
      </li>
    </ul>
  </footer>
</body>
