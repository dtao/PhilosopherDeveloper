<!DOCTYPE html>
<html>
  <head>
    <title>How I discovered a bug in the C# compiler, part 1 - The Philosopher Developer</title>
    <meta charset='utf-8' />
    <meta content='initial-scale=1.0, width=device-width, user-scalable=no' name='viewport' />
    <link href='/stylesheets/application.css' rel='stylesheet' />
    <link href='/stylesheets/pygments.css' rel='stylesheet' />
    <script src='http://w.sharethis.com/button/buttons.js' type='text/javascript'></script>
    <script src='/javascripts/ga.js' type='text/javascript'></script>
    <script src='/javascripts/shareThis.js' type='text/javascript'></script>
    <script src='/javascripts/jquery-1.9.1.min.js' type='text/javascript'></script>
    <!-- I've decided this isn't really worth doing until I make exceptions for -->
    <!-- sites that block iframes. -->
    <!-- %script(type="text/javascript" src="#{SITE_ROOT}/javascripts/main.js") -->
    <script type='text/javascript'>
      //<![CDATA[
        var disqus_shortname = "philosopherdeveloper";
        var disqus_title = "How I discovered a bug in the C# compiler, part 1";
      //]]>
    </script>
    
  </head>
  <body>
    <header id='header'>
      <h1>
        <a href='/posts/how-i-discovered-a-bug-in-the-csharp-compiler-part-1.html'>How I discovered a bug in the C# compiler, part 1</a>
      </h1>
      <h2><a href="/">the philosopher developer</a></h2>
    </header>
    <article>
  <header>
    <h1>
      March 31, 2011
    </h1>
    <span class='comments'><a href='#disqus_thread'></a></span>
    <script src='/javascripts/disqusCount.js' type='text/javascript'></script>
    <div class='social'>
      <span class='st_facebook_hcount' displayText='Facebook'></span>
      <span class='st_googleplus_hcount' displayText='Google+'></span>
      <span class='st_twitter_hcount' displayText='Tweet'></span>
      <span class='st_linkedin_hcount' displayText='LinkedIn'></span>
    </div>
  </header>
  <section class='content'>
    <p>This is the story of <strong>my epic adventure in discovering a bug in</strong> (the latest version of) <strong>the C# compiler</strong>.</p>

<p>First of all, some background. I was working on a library, mostly for personal use, which was to include an enumerable collection type similar to <code>List&lt;T&gt;</code> or <code>T[]</code>. One of the goals of this library was to be <em>efficient</em>; so, naturally, for this type’s enumerator I made the decision to create a mutable value type.</p>

<p><strong><em>Wait a minute!</em></strong> What’s that, you say? <em>Mutable value types are <strong>evil</strong>!</em> Oh?</p>

<p>This is a topic for a whole other blog post; but just to give a mini-argument in <em>defense</em> of this decision, by way of example, let me point out one simple fact: <strong>if you make the return value of <code>GetEnumerator</code> a <em>reference type</em>, then every <code>foreach</code> loop creates a new object to be garbage collected later</strong>. Don’t care? That’s fine; I <em>did</em> care, so I took an alternate approach (which, incidentally, is the same approach utilized by the designers of the collections in the <code>System.Collections.Generic</code> namespace in the BCL).</p>

<p>For <em>my</em> <code>GetEnumerator</code>, I explicitly implemented both <code>IEnumerable.GetEnumerator</code> <em>and</em> <code>IEnumerable&lt;T&gt;.GetEnumerator</code> and made a public version of the method returning an <code>Enumerator&lt;T&gt;</code> struct, like this:</p>

<div class="highlight"><pre><span class="k">public</span> <span class="n">Enumerator</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span> <span class="n">GetEnumerator</span><span class="p">()</span>
<span class="p">{</span>
  <span class="k">return</span> <span class="k">new</span> <span class="n">Enumerator</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;(</span><span class="k">this</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">IEnumerator</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span> <span class="n">IEnumerable</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;.</span><span class="n">GetEnumerator</span><span class="p">()</span>
<span class="p">{</span>
  <span class="k">return</span> <span class="nf">GetEnumerator</span><span class="p">();</span>
<span class="p">}</span>

<span class="n">System</span><span class="p">.</span><span class="n">Collections</span><span class="p">.</span><span class="n">IEnumerator</span> <span class="n">System</span><span class="p">.</span><span class="n">Collections</span><span class="p">.</span><span class="n">IEnumerable</span><span class="p">.</span><span class="n">GetEnumerator</span><span class="p">()</span>
<span class="p">{</span>
  <span class="k">return</span> <span class="nf">GetEnumerator</span><span class="p">();</span>
<span class="p">}</span>
</pre></div>

<p>This allowed my <code>Enumerator&lt;T&gt;</code> type to behave quite well when used in <code>foreach</code> loops without causing unnecessary garbage collection. And the fact that it was a mutable value type hardly mattered—just like it hardly matters for <code>List&lt;T&gt;.Enumerator</code>, <code>Dictionary&lt;TKey, TValue&gt;.Enumerator</code>, etc. (The only times when it hypothetically matters is when you pass an <code>Enumerator&lt;T&gt;</code> value to a method and for some reason <em>expect</em> the code within the method to affect the value outside that method’s scope—but that’s just insanity on your part!)</p>

<p>So I realize I could probably give a much more thorough explanation of that decision, but that’ll have to wait for another day. For now, let’s move on: so I had this mutable enumerator type. And naturally, since my goal was for this library to be high-quality, I decided to write some unit tests for it, my weapon of choice for that purpose being the same as everyone else’s in the .NET world: <a href="http://www.nunit.org/">NUnit</a>.</p>

<p>Here is a critical excerpt from one of these unit tests:</p>

<div class="highlight"><pre><span class="k">using</span> <span class="p">(</span><span class="kt">var</span> <span class="n">enumerator</span> <span class="p">=</span> <span class="n">_array</span><span class="p">.</span><span class="n">GetEnumerator</span><span class="p">())</span>
<span class="p">{</span>
  <span class="kt">int</span> <span class="n">x</span><span class="p">;</span>
  <span class="n">Assert</span><span class="p">.</span><span class="n">Throws</span><span class="p">&lt;</span><span class="n">InvalidOperationException</span><span class="p">&gt;(()</span> <span class="p">=&gt;</span> <span class="n">x</span> <span class="p">=</span> <span class="n">enumerator</span><span class="p">.</span><span class="n">Current</span><span class="p">);</span>
  
  <span class="k">while</span> <span class="p">(</span><span class="n">enumerator</span><span class="p">.</span><span class="n">MoveNext</span><span class="p">())</span>
  <span class="p">{</span> <span class="p">}</span>

  <span class="kt">var</span> <span class="n">enumeratorObject</span> <span class="p">=</span> <span class="p">(</span><span class="n">IEnumerator</span><span class="p">)</span><span class="n">enumerator</span><span class="p">;</span>
  <span class="n">enumeratorObject</span><span class="p">.</span><span class="n">Reset</span><span class="p">();</span>
  <span class="n">Assert</span><span class="p">.</span><span class="n">IsTrue</span><span class="p">(</span><span class="n">enumeratorObject</span><span class="p">.</span><span class="n">MoveNext</span><span class="p">());</span>
<span class="p">}</span>
</pre></div>

<p>What the heck is the point of that test? I’m glad you asked! Actually, I’m not glad, because the question sort of makes me realize that I did something rather dumb. But this will be educational for us all; so allow me to explain.</p>

<p>As you may or may not know, the <code>IEnumerator&lt;T&gt;</code> interface “inherits” from the non-generic <code>IEnumerator</code> interface, which in turn includes a <code>Reset</code> method. Frankly, <strong>this is insane</strong>, and is explicitly implemented (meaning: hidden) by practically <em>all</em> <code>IEnumerable&lt;T&gt;</code> implementations I’ve ever seen, including those in the BCL (like the aforementioned <code>List&lt;T&gt;</code>, etc.), for that very reason.</p>

<p>I took the same path: I hid it. But I also did something stupid: I <strong>also implemented it</strong>.</p>

<p>What’s so stupid about that? A couple of things. First and foremost, doing so violated the <a href="http://en.wikipedia.org/wiki/YAGNI">YAGNI principle</a>, in a truly spectacular way (YAGNI stands for “You ain’t gonna need it”; this mantra is cited often amongst software engineers to remind ourselves that sometimes it makes no sense to build a particular piece of functionality, because nobody asked for it and it’ll never get used). While I’m generally not one to blindly follow principles (at least I don’t <em>think</em> I am), in this case it’s almost painful to think about the irony of this choice. On the one hand I opted to <em>explicitly implement</em> a function, an act which basically says, <em>I want you **not** to use this so badly I'm going to make it invisible for you</em>; and on the other, I figured, <em>Eh, might as well make it work anyway</em>.</p>

<p>Don’t get me wrong: when I say I “implemented” it, I don’t mean to imply that I put any non-trivial amount of work into it. I didn’t. Implementing a <code>Reset</code> method for this particular enumerator type basically looked like this:</p>

<div class="highlight"><pre><span class="k">void</span> <span class="n">System</span><span class="p">.</span><span class="n">Collections</span><span class="p">.</span><span class="n">IEnumerator</span><span class="p">.</span><span class="n">Reset</span><span class="p">()</span>
<span class="p">{</span>
  <span class="n">_index</span> <span class="p">=</span> <span class="p">-</span><span class="m">1</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>

<p>But <a href="http://www.infoq.com/presentations/Null-References-The-Billion-Dollar-Mistake-Tony-Hoare">just because something’s easy to implement, that doesn’t mean it isn’t a mistake to do so</a>. If you’re not expecting anyone to ever use it, just don’t write it. It can only mislead and confuse others. That’s all I’m saying.</p>

<p>The second reason it was stupid? I’ll get to that.</p>

<p>What the test is supposed to <em>do</em> is this:</p>

<ol>
<li>Make sure <code>Current</code> cannot be called before enumeration starts (throw an exception in this case).</li>

<li>Move to the end of the enumerator, then call <code>Reset</code> and verify that you can start enumerating again.</li>
</ol><p>So, the code is written to do just that. We take this local enumerator value, we use it to enumerate whatever (until <code>MoveNext</code> returns <code>false</code>), and then we call <code>Reset</code> and verify that we can enumerate again. So it’s a test on the <code>Reset</code> method, essentially. (Really, it’s not a proper <strong>unit</strong> test at all. But once again: a topic for another post!)</p>

<p>Does it do what it’s supposed to do?</p>

<p>…</p>

<p>…</p>

<p>…</p>

<p>…</p>

<p>…</p>

<p>Hmm…</p>

<p>…</p>

<p>…</p>

<p>…</p>

<p>What the heck is going on?</p>

<p>When I first wrote the above test, I clicked “Run” and waited 5 seconds. Then I waited 5 more seconds. Then another 10. And I started to think, <em>There is no way it’s just taking Visual Studio (or NUnit) this long to load up; something is definitely wrong here</em>. (Unit tests should be <em>super</em> fast. Even more than 5 seconds for an entire suite of tests—at least for a project that isn’t huge—should constitute a red flag.)</p>

<p>Something <em>was</em> wrong. I stepped through Visual Studio’s debugger and found that the state of <code>enumerator</code> was not changing on consecutive calls to <code>MoveNext</code>. I would step into the method, see it increment the value of an <code>int</code> field, exit the method, and the field would be back to its original value.</p>

<p>To be honest, at first, I thought it had to do with NUnit. I thought, <em>NUnit</em> must be getting inside the byte code and fiddling with what I’ve written!</p>

<p>Nope. I put together a skeleton project with the same basic parts minus NUnit and tried again—same result.</p>

<p>So then I thought maybe it had something to do with a custom value type implementing <code>IDisposable</code>. So I tried this:</p>

<div class="highlight"><pre><span class="k">struct</span> <span class="nc">Enumerator</span> <span class="p">:</span> <span class="n">IDisposable</span>
<span class="p">{</span>
    <span class="kt">int</span> <span class="n">_field</span><span class="p">;</span>

    <span class="k">public</span> <span class="kt">int</span> <span class="nf">Increment</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="n">_field</span><span class="p">++;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">void</span> <span class="nf">Dispose</span><span class="p">()</span>
    <span class="p">{</span> <span class="p">}</span>
<span class="p">}</span>

<span class="k">using</span> <span class="p">(</span><span class="kt">var</span> <span class="n">s</span> <span class="p">=</span> <span class="k">new</span> <span class="n">SimpleStruct</span><span class="p">())</span>
<span class="p">{</span>
    <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="s">"{0}, {1}"</span><span class="p">,</span> <span class="n">s</span><span class="p">.</span><span class="n">Increment</span><span class="p">(),</span> <span class="n">s</span><span class="p">.</span><span class="n">Increment</span><span class="p">());</span>
<span class="p">}</span>
</pre></div>

<p>The above outputs <code>0, 1</code>. So that wasn’t it either.</p>

<p>Long story short, I eventually discovered it was <strong>the specific combination of mutating a value type inside a <code>using</code> statement <em>with</em> a closure</strong> that caused the behavior I was seeing. So, in other words:</p>

<div class="highlight"><pre><span class="c1">// This will output 0, 1.</span>
<span class="k">using</span> <span class="p">(</span><span class="kt">var</span> <span class="n">s</span> <span class="p">=</span> <span class="k">new</span> <span class="n">SimpleStruct</span><span class="p">())</span>
<span class="p">{</span>
    <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="s">"{0}, {1}"</span><span class="p">,</span> <span class="n">s</span><span class="p">.</span><span class="n">Increment</span><span class="p">(),</span> <span class="n">s</span><span class="p">.</span><span class="n">Increment</span><span class="p">());</span>
<span class="p">}</span>

<span class="c1">// This, however, will output 0, 0.</span>
<span class="k">using</span> <span class="p">(</span><span class="kt">var</span> <span class="n">s</span> <span class="p">=</span> <span class="k">new</span> <span class="n">SimpleStruct</span><span class="p">())</span>
<span class="p">{</span>
    <span class="c1">// Note: all we're doing is DECLARING this;</span>
    <span class="c1">// it doesn't even get used!</span>
    <span class="n">Func</span><span class="p">&lt;</span><span class="kt">int</span><span class="p">&gt;</span> <span class="n">closure</span> <span class="p">=</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="n">s</span><span class="p">.</span><span class="n">Increment</span><span class="p">();</span>

    <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="s">"{0}, {1}"</span><span class="p">,</span> <span class="n">s</span><span class="p">.</span><span class="n">Increment</span><span class="p">(),</span> <span class="n">s</span><span class="p">.</span><span class="n">Increment</span><span class="p">());</span>
<span class="p">}</span>
</pre></div>

<p>Because this has turned into such a long post (or it feels like one, anyway), I’m going to pull a typical me and split it into two posts. This feels like a good stopping point; can any readers figure out why the behavior of the two blocks of code above would be different? In my next post I will give the full explanation (which I have verified with someone on the actual C# compiler team). So don’t worry if you can’t figure it out; the answer’s on its way soon!</p>
    <div class='navigation'>
      <a class='previous' href='/posts/sometimes-the-best-strategy-is-to-retreat.html'>Sometimes the best strategy is to retreat</a>
      <a class='next' href='/posts/how-i-discovered-a-bug-in-the-csharp-compiler-part-2.html'>How I discovered a bug in the C# compiler, part 2</a>
    </div>
  </section>
  <section class='comments'>
    <div id='disqus_thread'></div>
    <script src='/javascripts/disqus.js' type='text/javascript'></script>
    <noscript>
      Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a>
    </noscript>
    <a class='dsq-brlink' href='http://disqus.com'>
      comments powered by
      <span class='logo-disqus'>Disqus</span>
    </a>
  </section>
</article>
    <footer>
      <ul class='menu'>
        <li><a href="/posts">All Posts</a></li>
        <li><a href="/about">About</a></li>
        <li>
          <a href='http://stackoverflow.com/users/105570' target='_blank'>
            <img alt='StackOverflow' src='/images/icons/stackoverflow-small.png' />
          </a>
        </li>
        <li>
          <a href='https://github.com/dtao' target='_blank'>
            <img alt='GitHub' src='/images/icons/github-small.png' />
          </a>
        </li>
        <li>
          <a href='https://twitter.com/dan_tao' target='_blank'>
            <img alt='Twitter' src='/images/icons/twitter-small.png' />
          </a>
        </li>
        <li>
          <a href='http://feeds.feedburner.com/philosopherdeveloper'>
            <img alt='RSS' src='/images/icons/rss-small.png' />
          </a>
        </li>
      </ul>
    </footer>
  </body>
</html>
