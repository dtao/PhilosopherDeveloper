<!DOCTYPE html>
<html>
  <head>
    <title>The Philosopher Developer</title>
    <meta charset='utf-8' />
    <meta content='initial-scale=1.0, width=device-width, user-scalable=no' name='viewport' />
    <link href='/stylesheets/application.css' rel='stylesheet' />
    <link href='/stylesheets/pygments.css' rel='stylesheet' />
    <script src='http://w.sharethis.com/button/buttons.js' type='text/javascript'></script>
    <script src='/javascripts/ga.js' type='text/javascript'></script>
    <script src='/javascripts/shareThis.js' type='text/javascript'></script>
    <script src='/javascripts/jquery-1.9.1.min.js' type='text/javascript'></script>
    <!-- I've decided this isn't really worth doing until I make exceptions for -->
    <!-- sites that block iframes. -->
    <!-- %script(type="text/javascript" src="#{SITE_ROOT}/javascripts/main.js") -->
    
    <script type='text/javascript' src='/javascripts/posts.js'></script>
  </head>
  <body>
    <header id='header'>
      <h1><a href="/">The Philosopher Developer</a></h1>
      <h2>half-sound logic, half-decent code</h2>
    </header>
    <article class='abbreviated'>
  <header>
    <h1>
      <span class='title'>
        <a href='/posts/jquery-mobile-trick-correction.html'>About that jQuery Mobile trick: Correction</a>
      </span>
      <span class='date'>July 26, 2011</span>
    </h1>
  </header>
  <section class='content'>
    <p>Faithful readers. There was an <strong>error</strong> in my previous post about refreshing styles in a jQuery Mobile app!</p>

<p><em>Ahhh!!!</em> I can hear you screaming. Calm down; <strong>I have a fix!</strong></p>

<p>(Warning: I’m not 100% sure I <em>understand</em> this fix; but hey, it’s JavaScript! <em>Nobody</em> really understands it, right?)</p>

<p>A refresher: what I suggested was this:</p>

<div class="highlight"><pre><span class="kd">function</span> <span class="nx">refreshStyles</span><span class="p">(</span> <span class="nx">$element</span> <span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">$wrapper</span> <span class="o">=</span> <span class="nx">$element</span><span class="p">.</span><span class="nx">wrap</span><span class="p">(</span> <span class="s2">"&lt;div&gt;"</span> <span class="p">);</span> <span class="c1">// This is a mistake!</span>
  <span class="nx">$wrapper</span><span class="p">.</span><span class="nx">page</span><span class="p">();</span>                         <span class="c1">// This doesn't work!</span>
  <span class="nx">$element</span><span class="p">.</span><span class="nx">unwrap</span><span class="p">();</span>
<span class="p">}</span>
</pre></div>

<p>The above code doesn’t work because <code>wrap</code> returns the <em>wrapped</em> element (not the <em>wrapper</em> element).</p>

<p>Here’s that fix I mentioned (incidentally, this is how it was coded in our code base at work all along… go figure):</p>

<div class="highlight"><pre><span class="kd">function</span> <span class="nx">refreshStyles</span><span class="p">(</span> <span class="nx">$element</span> <span class="p">)</span> <span class="p">{</span>
  <span class="nx">$element</span><span class="p">.</span><span class="nx">wrap</span><span class="p">(</span> <span class="s1">'&lt;div id="refresh-styles-wrapper"&gt;'</span> <span class="p">);</span> <span class="c1">// Look Ma, no local!</span>
  <span class="nx">$</span><span class="p">(</span><span class="s2">"#refresh-styles-wrapper"</span><span class="p">).</span><span class="nx">page</span><span class="p">();</span>                  <span class="c1">// Egads! It works!</span>
  <span class="nx">$element</span><span class="p">.</span><span class="nx">unwrap</span><span class="p">();</span>
<span class="p">}</span>
</pre></div>

<p>So yeah, somehow forcing jQuery to <em>re-find</em> the wrapper element makes everything honky dory. And if you don’t believe me, check it out:</p>

<p><a href="http://jsfiddle.net/tJwYs/1/">Proof.</a></p>
<div class="footnotes">
<hr>
<ol><li id="fn:1">
<p>I have this theory that JavaScript is the language with the greatest percentage of <em>hackers</em>, as opposed to actual developers. By which I mean, most of us just <a href="http://jsfiddle.net/">fiddle around</a> with JS code until it works; but we don’t entirely <em>get</em> what we’re doing. At least that’s the case with me. (Don’t tell my employer.) <a href="#fnref:1" rev="footnote">↩</a></p>
</li></ol>
</div>
  </section>
</article>
<article class='abbreviated'>
  <header>
    <h1>
      <span class='title'>
        <a href='/posts/little-jquery-mobile-trick.html'>A little jQuery Mobile trick</a>
      </span>
      <span class='date'>July 25, 2011</span>
    </h1>
  </header>
  <section class='content'>
    <p>I don’t really have anything revolutionary to share with the world at the moment, but I <strong>do</strong> want to get back into writing regular posts; so I figured I’d share a little <a href="http://jquerymobile.com/">jQuery Mobile</a> trick, since I’ve been using this library quite a bit lately for work.</p>

<p>Sometimes in JQM, you find that your page suddenly looks like garbage. Maybe you updated the data being displayed using a <a href="http://api.jquery.com/category/plugins/templates/">jQuery template</a>; or you rendered a form, navigated to a different page, then came back, and all of your JQM-provided styling mysteriously vanished.</p>

<p>You’re <a href="http://stackoverflow.com/questions/5249250">not alone</a>; this problem seems to have affected quite a few web developers out there in the wild, giving jQuery Mobile the ol’ college try.</p>

<p>Part of the problem here (which has driven more than a few of us to near-madness) is that the JQM team seem to have decided that calling <code>page()</code> on a jQuery object should… not actually <em>do</em> anything after the first time you call it. So maybe you tried adding a call to <code>page()</code> in your code, did your usual dance to reproduce the rendering problem, saw that everything was fine and thought, <em>Huzzah! All fixed!</em> And then the next day somehow you noticed the problem inexplicably resurface.</p>

<p>My <em>guess</em> is that JQM does this for optimization purposes, since JavaScript can be relatively expensive to run on mobile devices, especially those a generation or two back. So the developers figured, <em>Hey, if somebody calls <code>page()</code> multiple times, everything should already look fine after the first call; so we’ll just do him/her a favor and ignore subsequent calls!</em> Which… I don’t know. Honestly, I can imagine myself making the same (wrong, in my opinion) decision.</p>

<p><strong>Anyway</strong>, here’s the “trick” I promised: my coworkers and I found an <strong>ingenious</strong> solution to the “one <span class="post-link">... (<a href="/posts/little-jquery-mobile-trick.html">read the full post</a>)</span></p>
  </section>
</article>
<article class='abbreviated'>
  <header>
    <h1>
      <span class='title'>
        <a href='/posts/how-i-discovered-a-bug-in-the-csharp-compiler-part-2.html'>How I discovered a bug in the C# compiler, part 2</a>
      </span>
      <span class='date'>April 03, 2011</span>
    </h1>
  </header>
  <section class='content'>
    <p>This post continues from where <a href="/posts/how-i-discovered-a-bug-in-the-c-compiler-part-1.html">my last one</a> left off; but don’t worry—I swear I’ll make this one more less rambling and more comprehensible. And rest assured that I will actually get to the explanation this time!</p>

<p>So where did we leave off? We witnessed some truly bizarre behavior of a <strong>mutable value type</strong> within a <strong>using statement</strong> which also happens to include a <strong>closure</strong>. What does this look like?</p>

<p>How about instead of using a custom value type to illustrate, this time I’ll show you what I mean with a type straight from the BCL itself (meaning, this guy was written by Microsoft folks, so you know it’s not just something weird about the way <em>I</em> did things):</p>

<div class="highlight"><pre><span class="kt">var</span> <span class="n">list</span> <span class="p">=</span> <span class="k">new</span> <span class="n">List</span><span class="p">&lt;</span><span class="kt">int</span><span class="p">&gt;</span> <span class="p">{</span> <span class="m">1</span><span class="p">,</span> <span class="m">2</span><span class="p">,</span> <span class="m">3</span> <span class="p">};</span>

<span class="c1">// Criterion 1: within a using statement...</span>
<span class="k">using</span> <span class="p">(</span><span class="kt">var</span> <span class="n">e</span> <span class="p">=</span> <span class="n">list</span><span class="p">.</span><span class="n">GetEnumerator</span><span class="p">())</span>
<span class="p">{</span>
    <span class="c1">// Criterion 2: ...which includes a closure...</span>
    <span class="n">Func</span><span class="p">&lt;</span><span class="kt">int</span><span class="p">&gt;</span> <span class="n">closure</span> <span class="p">=</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="n">e</span><span class="p">.</span><span class="n">Current</span><span class="p">;</span>
    
    <span class="c1">// Criterion 3: ...a mutable value type...</span>
    <span class="k">while</span> <span class="p">(</span><span class="n">e</span><span class="p">.</span><span class="n">MoveNext</span><span class="p">())</span>
    <span class="p">{</span>
        <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="n">e</span><span class="p">.</span><span class="n">Current</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>

<p><strong>What do you think the above program will print?</strong></p>

<p>Well, if you were paying <em>attention</em> to my last post (and if not—honestly, I totally understand), you’d know the answer already. The above program outputs:</p>

<pre><code>0
0
0
0
0</code></pre>

<p>…and on and on, ad infinitum.</p>

<p>Remember, this happens <em>specifically</em> when all three of the above criteria (reiterated in the code comments) are met. It does <em>not</em> happen when only one or two of those criteria are met.</p>

<p>Now let’s get to the bottom of this. In order to do so, there are a few puzzle pieces we need to understand.</p>

<h2 id="puzzle_piece_1_how_does_the_c_compiler_implement_closures_1">Puzzle Piece #1: How does the C# compiler implement closures?</h2>

<p>This one’s a head-scratcher for a lot of C# developers who’ve never really looked into the inner workings of closures. I’d <span class="post-link">... (<a href="/posts/how-i-discovered-a-bug-in-the-csharp-compiler-part-2.html">read the full post</a>)</span></p>
  </section>
</article>
<article class='abbreviated'>
  <header>
    <h1>
      <span class='title'>
        <a href='/posts/how-i-discovered-a-bug-in-the-csharp-compiler-part-1.html'>How I discovered a bug in the C# compiler, part 1</a>
      </span>
      <span class='date'>March 31, 2011</span>
    </h1>
  </header>
  <section class='content'>
    <p>This is the story of <strong>my epic adventure in discovering a bug in</strong> (the latest version of) <strong>the C# compiler</strong>.</p>

<p>First of all, some background. I was working on a library, mostly for personal use, which was to include an enumerable collection type similar to <code>List&lt;T&gt;</code> or <code>T[]</code>. One of the goals of this library was to be <em>efficient</em>; so, naturally, for this type’s enumerator I made the decision to create a mutable value type.</p>

<p><strong><em>Wait a minute!</em></strong> What’s that, you say? <em>Mutable value types are <strong>evil</strong>!</em> Oh?</p>

<p>This is a topic for a whole other blog post; but just to give a mini-argument in <em>defense</em> of this decision, by way of example, let me point out one simple fact: <strong>if you make the return value of <code>GetEnumerator</code> a <em>reference type</em>, then every <code>foreach</code> loop creates a new object to be garbage collected later</strong>. Don’t care? That’s fine; I <em>did</em> care, so I took an alternate approach (which, incidentally, is the same approach utilized by the designers of the collections in the <code>System.Collections.Generic</code> namespace in the BCL).</p>

<p>For <em>my</em> <code>GetEnumerator</code>, I explicitly implemented both <code>IEnumerable.GetEnumerator</code> <em>and</em> <code>IEnumerable&lt;T&gt;.GetEnumerator</code> and made a public version of the method returning an <code>Enumerator&lt;T&gt;</code> struct, like this:</p>

<div class="highlight"><pre><span class="k">public</span> <span class="n">Enumerator</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span> <span class="n">GetEnumerator</span><span class="p">()</span>
<span class="p">{</span>
  <span class="k">return</span> <span class="k">new</span> <span class="n">Enumerator</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;(</span><span class="k">this</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">IEnumerator</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span> <span class="n">IEnumerable</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;.</span><span class="n">GetEnumerator</span><span class="p">()</span>
<span class="p">{</span>
  <span class="k">return</span> <span class="nf">GetEnumerator</span><span class="p">();</span>
<span class="p">}</span>

<span class="n">System</span><span class="p">.</span><span class="n">Collections</span><span class="p">.</span><span class="n">IEnumerator</span> <span class="n">System</span><span class="p">.</span><span class="n">Collections</span><span class="p">.</span><span class="n">IEnumerable</span><span class="p">.</span><span class="n">GetEnumerator</span><span class="p">()</span>
<span class="p">{</span>
  <span class="k">return</span> <span class="nf">GetEnumerator</span><span class="p">();</span>
<span class="p">}</span>
</pre></div>

<p>This allowed my <code>Enumerator&lt;T&gt;</code> type to behave quite well when used in <code>foreach</code> loops without causing unnecessary garbage collection. And the fact that it was a mutable value type hardly mattered—just like it hardly matters for <code>List&lt;T&gt;.Enumerator</code>, <code>Dictionary&lt;TKey, TValue&gt;.Enumerator</code>, etc. (The only times when it hypothetically matters is when you pass an <code>Enumerator&lt;T&gt;</code> value to a method and for some reason <em>expect</em> the code within the method to affect the <span class="post-link">... (<a href="/posts/how-i-discovered-a-bug-in-the-csharp-compiler-part-1.html">read the full post</a>)</span></p>
  </section>
</article>
<article class='abbreviated'>
  <header>
    <h1>
      <span class='title'>
        <a href='/posts/sometimes-the-best-strategy-is-to-retreat.html'>Sometimes the best strategy is to retreat</a>
      </span>
      <span class='date'>February 28, 2011</span>
    </h1>
  </header>
  <section class='content'>
    <p>I have a few remarks to make about <a href="http://dtao.github.com/ConcurrentList/">my <code>ConcurrentList&lt;T&gt;</code> class</a>, which I have written about a <a href="/posts/how-to-build-a-thread-safe-lock-free-resizable-array.html">couple</a> of <a href="/posts/boy-can-dream.html">times</a> already.</p>

<p><em>What, are you “retreating” from your concurrent list idea?</em> In a way, yes. Let me explain. From the beginning, my concept of the usefulness of a lock-free <code>IList&lt;T&gt;</code> implementation was that it would scale better than using a <code>List&lt;T&gt;</code> plus <code>lock</code> statements by eliminating contention when many threads are accessing the list concurrently.</p>

<p>Is this actually true? Accessing the list <code>how</code>?</p>

<p>Since a concurrent implementation of <code>Insert</code>, <code>RemoveAt</code> etc. is not supported in <code>ConcurrentList&lt;T&gt;</code>, there are really only a few operations that need to be considered:</p>

<ul>
<li>Getting/setting an item at a specified index</li>

<li>Adding to the list</li>

<li>Iterating over the list</li>
</ul><p>Critically, I think the assumption is that one would need a lock-free data structure to optimize the scenario where multiple threads may be <em>reading</em> from the list (via accessing items at random indexes) while one or more other threads are <em>adding</em> to it. <strong>I actually don’t think you need a lock-free data structure for this at all.</strong></p>

<p>Here’s the thing: if you’ve got a <code>List&lt;T&gt;</code>, and you synchronize all calls to <code>Add</code> with, e.g., a <code>lock</code> statement, <strong>you don’t need to also synchronize reads</strong>. They will <em>always</em> be thread-safe. Accessing an element at an index of a <code>List&lt;T&gt;</code> that is <em>only</em> growing with calls to <code>Add</code> <em>will</em> work from multiple threads. If you are skeptical, consider what actually happens when <code>Add</code> is called (<strong>warning: reliance upon specific implementation details ahead!</strong>):</p>

<ol>
<li>
<p>The <code>List&lt;T&gt;</code> gets the next available index in its internal array.</p>
</li>

<li>
<p>If the index is beyond the end of the array:</p>

<ol>
<li>A new array is allocated.</li>

<li>The elements of the current array are copied over.</li>

<li>A reference to this new <span class="post-link">... (<a href="/posts/sometimes-the-best-strategy-is-to-retreat.html">read the full post</a>)</span>
</li>
</ol>
</li>
</ol>
  </section>
</article>
<div class='next-page'>
  <a href='/index7.html'>View older posts</a>
</div>
    <footer>
      <ul class='menu'>
        <li><a href="/posts">All Posts</a></li>
        <li><a href="/about">About</a></li>
        <li>
          <a href='http://stackoverflow.com/users/105570' target='_blank'>
            <img alt='StackOverflow' src='/images/icons/stackoverflow-small.png' />
          </a>
        </li>
        <li>
          <a href='https://github.com/dtao' target='_blank'>
            <img alt='GitHub' src='/images/icons/github-small.png' />
          </a>
        </li>
        <li>
          <a href='https://twitter.com/dan_tao' target='_blank'>
            <img alt='Twitter' src='/images/icons/twitter-small.png' />
          </a>
        </li>
        <li>
          <a href='http://feeds.feedburner.com/philosopherdeveloper'>
            <img alt='RSS' src='/images/icons/rss-small.png' />
          </a>
        </li>
      </ul>
    </footer>
  </body>
</html>
